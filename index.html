<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dream Harbour - Professional Invoicing System</title>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafb; color: #1a202c; }
    
    .container { display: flex; height: 100vh; }
    .sidebar { width: 280px; background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%); color: white; padding: 30px 20px; overflow-y: auto; }
    .sidebar-header { display: flex; align-items: center; gap: 12px; margin-bottom: 30px; }
    .sidebar-logo { width: 40px; height: 40px; background: rgba(255,255,255,0.95); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 700; color: #1e40af; }
    .sidebar-title { font-size: 18px; font-weight: 700; }
    .nav-item { padding: 12px 16px; margin-bottom: 8px; cursor: pointer; border-radius: 8px; transition: all 0.3s; font-size: 14px; font-weight: 500; }
    .nav-item:hover { background: rgba(255,255,255,0.15); }
    .nav-item.active { background: rgba(255,255,255,0.25); border-left: 3px solid white; padding-left: 13px; }
    
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .topbar { background: white; padding: 20px 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; }
    .topbar-title { font-size: 24px; font-weight: 700; }
    .logout-btn { padding: 8px 16px; background: #fee2e2; color: #dc2626; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
    .logout-btn:hover { background: #fca5a5; }
    
    .content { flex: 1; overflow-y: auto; padding: 30px; }
    .section { display: none; }
    .section.active { display: block; }
    
    .form-section { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 24px; }
    .section-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #e2e8f0; }
    .section-subtitle { font-size: 14px; font-weight: 600; color: #1a202c; margin-top: 20px; margin-bottom: 12px; }
    
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px; }
    .form-field { display: flex; flex-direction: column; }
    .form-field label { font-size: 12px; font-weight: 600; color: #2d3748; margin-bottom: 6px; text-transform: uppercase; }
    .form-field input, .form-field select, .form-field textarea { padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px; font-family: inherit; transition: all 0.3s; }
    .form-field input:focus, .form-field select:focus, .form-field textarea:focus { outline: none; border-color: #1e40af; box-shadow: 0 0 0 3px rgba(30,64,175,0.1); }
    .form-field.mandatory label::after { content: ' *'; color: #dc2626; }
    
    .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; text-transform: uppercase; }
    .btn-primary { background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%); color: white; box-shadow: 0 4px 15px rgba(30,64,175,0.3); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 25px rgba(30,64,175,0.4); }
    .btn-danger { background: #fee2e2; color: #dc2626; }
    .btn-success { background: #d1fae5; color: #059669; }
    .btn-secondary { background: #f3f4f6; color: #4b5563; }
    
    .error-message, .success-message, .warning-message { font-size: 12px; margin-bottom: 16px; padding: 10px 12px; border-radius: 6px; display: none; }
    .error-message { color: #dc2626; background: #fee2e2; }
    .success-message { color: #059669; background: #d1fae5; }
    .warning-message { color: #d97706; background: #fef3c7; }
    .error-message.show, .success-message.show, .warning-message.show { display: block; }
    
    .customer-dropdown { max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 6px; margin-top: 8px; }
    .customer-option { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #e2e8f0; }
    .customer-option:hover { background: #f7fafc; }
    
    .invoice-preview { background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 30px; margin-top: 20px; font-size: 12px; line-height: 1.6; }
    .invoice-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #1e40af; padding-bottom: 15px; }
    .invoice-title { font-size: 24px; font-weight: 700; color: #1e40af; }
    .invoice-subtitle { font-size: 12px; color: #718096; margin-top: 5px; }
    
    .invoice-info { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; font-size: 11px; }
    .invoice-info-block { border: 1px solid #e2e8f0; padding: 12px; border-radius: 6px; }
    .invoice-info-title { font-weight: 600; margin-bottom: 6px; }
    
    .invoice-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    .invoice-table th { background: #1e40af; color: white; padding: 10px; text-align: left; font-size: 11px; font-weight: 600; }
    .invoice-table td { padding: 8px 10px; border-bottom: 1px solid #e2e8f0; }
    .invoice-table tr:hover { background: #f7fafc; }
    .invoice-total-row { font-weight: 600; background: #1e40af; color: white; }
    .invoice-total-row td { border: none; }
    
    .service-card { background: #f7fafc; padding: 12px; border-radius: 6px; margin-bottom: 12px; border-left: 3px solid #1e40af; }
    .service-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .service-card-title { font-weight: 600; }
    .service-card-remove { color: #dc2626; cursor: pointer; font-size: 12px; }
    .service-card-details { font-size: 11px; color: #718096; }
    
    .amount-display { font-size: 14px; font-weight: 600; color: #1e40af; padding: 8px 12px; background: #f0f4f8; border-radius: 6px; }
  </style>
</head>
<body>

<div class="container">
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">DH</div>
      <div class="sidebar-title">Dream Harbour</div>
    </div>
    <nav>
      <div class="nav-item active" onclick="showSection('invoice')">üìÑ Generate Invoice</div>
    </nav>
  </div>

  <div class="main-content">
    <div class="topbar">
      <div class="topbar-title">Generate Invoice</div>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <div class="content">
      <div id="invoice-section" class="section active">
        <div class="form-section">
          <div class="error-message" id="errorMessage"></div>
          <div class="success-message" id="successMessage"></div>
          <div class="warning-message" id="warningMessage"></div>

          <!-- CUSTOMER DETAILS -->
          <div class="section-title">üìã Customer Details</div>
          
          <div class="form-row">
            <div class="form-field mandatory">
              <label>Mobile No (10 Digits)</label>
              <input type="tel" id="customerPhone" placeholder="9876543210" maxlength="10" onchange="checkExistingCustomer()">
              <div class="customer-dropdown" id="customerDropdown" style="display: none;"></div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-field mandatory">
              <label>Full Name</label>
              <input type="text" id="customerName" placeholder="Enter full name">
            </div>
            <div class="form-field">
              <label>Email</label>
              <input type="email" id="customerEmail" placeholder="email@example.com">
            </div>
          </div>

          <div class="form-row">
            <div class="form-field">
              <label>GSTIN</label>
              <input type="text" id="customerGstin" placeholder="27AABBU1234F1Z5">
            </div>
            <div class="form-field">
              <label>Address</label>
              <input type="text" id="customerAddress" placeholder="Full address">
            </div>
          </div>

          <!-- SERVICES -->
          <div class="section-title" style="margin-top: 30px;">üõ†Ô∏è Services Given</div>

          <div class="form-row">
            <div class="form-field">
              <label>Service Type</label>
              <select id="serviceType" onchange="handleServiceChange()">
                <option value="">Select Service</option>
                <option value="photocopy">Photostat/Copy</option>
                <option value="aadhar-pan">Aadhar Pan Linking</option>
                <option value="registration">Registration Fees</option>
                <option value="driving-license">Driving Licence</option>
                <option value="e-stamping">E-Stamping</option>
                <option value="jamabandi">Jamabandi</option>
                <option value="nepal-money">Nepal Money Transfer</option>
                <option value="online-cert">Online Certificates</option>
                <option value="online-internet">Online Internet Services</option>
                <option value="pan-others">Pan Card and Others</option>
                <option value="print-bw">Printing Black and White</option>
                <option value="print-color">Printing Color</option>
                <option value="affidavit">Affidavit/Application</option>
                <option value="deed-writing">Deed Writing</option>
                <option value="custom">Add New Service</option>
              </select>
            </div>

            <div class="form-field" id="quantityField" style="display: none;">
              <label>Quantity/Pages/No. of Services</label>
              <input type="number" id="serviceQuantity" placeholder="Enter quantity" min="1">
            </div>

            <div class="form-field" id="manualAmountField" style="display: none;">
              <label>Amount (‚Çπ)</label>
              <input type="number" id="serviceAmount" placeholder="Enter amount" step="0.01">
            </div>
          </div>

          <!-- CUSTOM SERVICE -->
          <div id="customServiceSection" style="display: none; border-top: 2px solid #e2e8f0; padding-top: 16px;">
            <div class="form-row">
              <div class="form-field mandatory">
                <label>Service Description</label>
                <input type="text" id="customDescription" placeholder="e.g., Specialized office support services">
              </div>
              <div class="form-field mandatory">
                <label>SAC Code</label>
                <input type="text" id="customSacCode" placeholder="e.g., 998595">
              </div>
            </div>
            <div class="form-row">
              <div class="form-field mandatory">
                <label>GST %</label>
                <input type="number" id="customGst" placeholder="e.g., 18" min="0" max="100" step="0.1">
              </div>
              <div class="form-field mandatory">
                <label>Rate/Amount (‚Çπ)</label>
                <input type="number" id="customRate" placeholder="e.g., 500" step="0.01">
              </div>
            </div>
          </div>

          <button class="btn btn-primary" onclick="addService()" style="margin-top: 16px;">Add Service to Invoice</button>

          <!-- SELECTED SERVICES LIST -->
          <div id="selectedServices" style="margin-top: 24px;"></div>

          <!-- INVOICE PREVIEW -->
          <div id="invoicePreview"></div>

          <!-- ACTIONS -->
          <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn btn-success" onclick="generateInvoicePDF()">Generate & Download Invoice</button>
            <button class="btn btn-secondary" onclick="resetForm()">Clear All</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyC-tQWS8o_Y7ZJtI3JjW9Uk4I9aHJ1ZDxs",
  authDomain: "dream-harbour.firebaseapp.com",
  projectId: "dream-harbour",
  storageBucket: "dream-harbour.firebasestorage.app",
  messagingSenderId: "857245144265",
  appId: "1:857245144265:web:6855412224da516592e918"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;
let invoiceData = {
  customer: {},
  services: [],
  invoiceNumber: null,
  invoiceDate: new Date().toISOString().split('T')[0]
};

const SERVICE_CONFIGS = {
  'photocopy': {
    name: 'Photostat/Copy',
    primaryService: { desc: 'Photostat/Copy Services', sac: '998595', gst: 18, needsQuantity: true, rate: 5 },
    autoServices: []
  },
  'aadhar-pan': {
    name: 'Aadhar Pan Linking',
    primaryService: { desc: 'Specialized office support services (e.g., document preparation, form filling, etc.)', sac: '998595', gst: 0, needsQuantity: true, rate: 200 },
    autoServices: [{ desc: 'Government Fee (Paid to Income Tax Dept.)', sac: 'NA', gst: 0, rate: 1000, serial: 1 }]
  },
  'registration': {
    name: 'Registration Fees',
    primaryService: { desc: 'Specialized office support services (e.g., document preparation, form filling, etc.)', sac: '998599', gst: 0, needsQuantity: true, rate: 30 },
    autoServices: [{ desc: 'Government Fee (Paid to IG of Registration)', sac: 'NA', gst: 0, rate: 1000, serial: 1 }]
  },
  'driving-license': {
    name: 'Driving Licence',
    primaryService: { desc: 'Specialized office support services (e.g., document preparation, form filling, etc.)', sac: '998599', gst: 0, needsQuantity: false, needsManual: true },
    autoServices: [{ desc: 'Government Fee', sac: 'NA', gst: 0, needsManual: true, serial: 1 }]
  },
  'e-stamping': {
    name: 'E-Stamping',
    primaryService: { desc: 'Specialized office support services (e.g., document preparation, form filling, etc.)', sac: '998599', gst: 0, needsQuantity: false, needsManual: true },
    autoServices: [{ desc: 'E-Stamp Paper Fees', sac: 'NA', gst: 0, needsManual: true, serial: 1 }]
  },
  'jamabandi': {
    name: 'Jamabandi',
    primaryService: { desc: 'Specialized office support services (e.g., document preparation, form filling, etc.)', sac: '998599', gst: 18, needsQuantity: false, needsManual: true },
    autoServices: [{ desc: 'Government Statutory Fee', sac: 'NA', gst: 0, needsManual: true, serial: 1 }]
  },
  'nepal-money': {
    name: 'Nepal Money Transfer',
    primaryService: { desc: 'Nepal Money Transfer Facilitation / Service Fee', sac: '997159', gst: 18, needsQuantity: false, needsManual: true },
    autoServices: [{ desc: 'Remitted Money', sac: 'NA', gst: 0, needsManual: true, serial: 1 }]
  },
  'online-cert': {
    name: 'Online Certificates',
    primaryService: { desc: 'Specialized office support services (e.g., document preparation, form filling, etc.)', sac: '998595', gst: 18, needsQuantity: false, needsManual: true },
    autoServices: [{ desc: 'Government Statutory Fee', sac: 'NA', gst: 0, needsManual: true, serial: 1 }]
  },
  'online-internet': {
    name: 'Online Internet Services',
    primaryService: { desc: 'Specialized office support services (e.g., document preparation, form filling, etc.)', sac: '998595', gst: 18, needsQuantity: false, needsManual: true },
    autoServices: [{ desc: 'Statutory Fee', sac: 'NA', gst: 0, needsManual: true, serial: 1 }]
  },
  'pan-others': {
    name: 'Pan Card and Others',
    primaryService: { desc: 'Specialized office support services (e.g., document preparation, form filling, etc.)', sac: '998595', gst: 0, needsQuantity: true, rate: 100 },
    autoServices: [{ desc: 'Government Fee (Paid to Income Tax Dept.)', sac: 'NA', gst: 0, rate: 100, serial: 1 }]
  },
  'print-bw': {
    name: 'Printing Black and White',
    primaryService: { desc: 'Specialised office support services such as duplicating services, mailing services, document preparation and the like', sac: '998595', gst: 18, needsQuantity: true, rate: 5 },
    autoServices: []
  },
  'print-color': {
    name: 'Printing Color',
    primaryService: { desc: 'Specialised office support services such as duplicating services, mailing services, document preparation and the like', sac: '998595', gst: 18, needsQuantity: true, rate: 15 },
    autoServices: []
  },
  'affidavit': {
    name: 'Affidavit/Application',
    primaryService: { desc: 'Affidavit/Application Typing', sac: '998595', gst: 18, needsQuantity: false, needsManual: true },
    autoServices: [{ desc: 'Document Handling / Processing Fee', sac: 'NA', gst: 0, needsManual: true, serial: 1 }]
  },
  'deed-writing': {
    name: 'Deed Writing',
    primaryService: { desc: 'Deed Typing', sac: '998595', gst: 18, needsQuantity: false, needsManual: true },
    autoServices: [{ desc: 'Document Handling / Processing Fee', sac: 'NA', gst: 0, needsManual: true, serial: 1 }]
  }
};

function showError(msg) {
  const el = document.getElementById('errorMessage');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 5000);
}

function showSuccess(msg) {
  const el = document.getElementById('successMessage');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 3000);
}

function showWarning(msg) {
  const el = document.getElementById('warningMessage');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 5000);
}

function handleServiceChange() {
  const serviceType = document.getElementById('serviceType').value;
  document.getElementById('customServiceSection').style.display = serviceType === 'custom' ? 'block' : 'none';
  document.getElementById('quantityField').style.display = serviceType && serviceType !== 'custom' ? 'block' : 'none';
  document.getElementById('manualAmountField').style.display = 'none';
  
  if (serviceType && serviceType !== 'custom') {
    const config = SERVICE_CONFIGS[serviceType];
    if (config.primaryService.needsManual) {
      document.getElementById('manualAmountField').style.display = 'block';
    }
  }
}

function checkExistingCustomer() {
  const phone = document.getElementById('customerPhone').value;
  if (phone.length !== 10) {
    document.getElementById('customerDropdown').style.display = 'none';
    return;
  }
  
  const customers = JSON.parse(localStorage.getItem('customers') || '[]');
  const matches = customers.filter(c => c.phone === phone);
  
  if (matches.length > 0) {
    let html = '';
    matches.forEach(c => {
      html += `<div class="customer-option" onclick="selectCustomer('${c.phone}', true)">${c.name} - ${c.phone} (Select)</div>`;
    });
    html += `<div class="customer-option" style="background: #fee2e2; color: #dc2626;" onclick="confirmNewEntry()">Enter New Customer with Same Number</div>`;
    document.getElementById('customerDropdown').innerHTML = html;
    document.getElementById('customerDropdown').style.display = 'block';
  } else {
    document.getElementById('customerDropdown').style.display = 'none';
  }
}

function selectCustomer(phone, selected) {
  const customers = JSON.parse(localStorage.getItem('customers') || '[]');
  const customer = customers.find(c => c.phone === phone);
  if (customer) {
    document.getElementById('customerPhone').value = customer.phone;
    document.getElementById('customerName').value = customer.name;
    document.getElementById('customerEmail').value = customer.email || '';
    document.getElementById('customerGstin').value = customer.gstin || '';
    document.getElementById('customerAddress').value = customer.address || '';
    document.getElementById('customerDropdown').style.display = 'none';
  }
}

function confirmNewEntry() {
  if (confirm('This phone number already exists. Do you want to create a new entry?')) {
    document.getElementById('customerName').value = '';
    document.getElementById('customerEmail').value = '';
    document.getElementById('customerGstin').value = '';
    document.getElementById('customerAddress').value = '';
    document.getElementById('customerDropdown').style.display = 'none';
  }
}

function addService() {
  const serviceType = document.getElementById('serviceType').value;
  if (!serviceType) {
    showError('Please select a service');
    return;
  }

  let service = {};
  
  if (serviceType === 'custom') {
    if (!document.getElementById('customDescription').value || !document.getElementById('customSacCode').value) {
      showError('Please fill all required fields');
      return;
    }
    service = {
      type: 'custom',
      desc: document.getElementById('customDescription').value,
      sac: document.getElementById('customSacCode').value,
      gst: parseFloat(document.getElementById('customGst').value) || 0,
      rate: parseFloat(document.getElementById('customRate').value) || 0,
      quantity: 1,
      amount: parseFloat(document.getElementById('customRate').value) || 0
    };
  } else {
    const config = SERVICE_CONFIGS[serviceType];
    let quantity = 1;
    let rate = config.primaryService.rate;
    
    if (config.primaryService.needsQuantity) {
      quantity = parseInt(document.getElementById('serviceQuantity').value) || 1;
      if (quantity < 1) {
        showError('Quantity must be at least 1');
        return;
      }
    } else if (config.primaryService.needsManual) {
      rate = parseFloat(document.getElementById('serviceAmount').value);
      if (!rate || rate < 0) {
        showError('Please enter valid amount');
        return;
      }
    }
    
    service = {
      type: serviceType,
      desc: config.primaryService.desc,
      sac: config.primaryService.sac,
      gst: config.primaryService.gst,
      quantity: quantity,
      rate: rate,
      amount: rate * quantity
    };
  }

  invoiceData.services.push(service);
  
  // Add auto services
  if (serviceType !== 'custom' && SERVICE_CONFIGS[serviceType].autoServices.length > 0) {
    SERVICE_CONFIGS[serviceType].autoServices.forEach(autoSvc => {
      const autoService = { ...autoSvc };
      if (autoSvc.needsManual) {
        autoService.rate = parseFloat(document.getElementById('serviceAmount').value) || 0;
      }
      autoService.amount = autoService.rate * (autoService.quantity || 1);
      invoiceData.services.push(autoService);
    });
  }

  updateInvoicePreview();
  resetServiceForm();
  showSuccess('Service added to invoice');
}

function resetServiceForm() {
  document.getElementById('serviceType').value = '';
  document.getElementById('serviceQuantity').value = '';
  document.getElementById('serviceAmount').value = '';
  document.getElementById('customDescription').value = '';
  document.getElementById('customSacCode').value = '';
  document.getElementById('customGst').value = '';
  document.getElementById('customRate').value = '';
  handleServiceChange();
}

function updateInvoicePreview() {
  let html = '<div class="invoice-preview">';
  
  // Header
  html += '<div class="invoice-header">';
  html += '<div class="invoice-title">INVOICE</div>';
  html += '<div class="invoice-subtitle">Dream Harbour Professional Services</div>';
  html += `<div class="invoice-subtitle">Date: ${invoiceData.invoiceDate}</div>`;
  html += '</div>';

  // Customer Info
  html += '<div class="invoice-info">';
  html += '<div class="invoice-info-block"><div class="invoice-info-title">Bill To:</div>';
  html += `<div><strong>${document.getElementById('customerName').value || 'N/A'}</strong></div>`;
  html += `<div>Phone: ${document.getElementById('customerPhone').value || 'N/A'}</div>`;
  if (document.getElementById('customerEmail').value) html += `<div>Email: ${document.getElementById('customerEmail').value}</div>`;
  if (document.getElementById('customerGstin').value) html += `<div>GSTIN: ${document.getElementById('customerGstin').value}</div>`;
  if (document.getElementById('customerAddress').value) html += `<div>Address: ${document.getElementById('customerAddress').value}</div>`;
  html += '</div>';
  html += '<div class="invoice-info-block"><div class="invoice-info-title">Invoice Details:</div>';
  html += `<div>Invoice #: ${invoiceData.invoiceNumber || 'Draft'}</div>`;
  html += `<div>Date: ${invoiceData.invoiceDate}</div>`;
  html += '</div></div>';

  // Services Table
  html += '<table class="invoice-table"><thead><tr><th>S.No</th><th>Description</th><th>SAC Code</th><th>Qty</th><th>Rate (‚Çπ)</th><th>Amount (‚Çπ)</th><th>GST %</th><th>GST Amt (‚Çπ)</th><th>Total (‚Çπ)</th></tr></thead><tbody>';

  let totalAmount = 0, totalGst = 0;
  invoiceData.services.forEach((svc, idx) => {
    const gstAmount = (svc.amount * svc.gst) / 100;
    const total = svc.amount + gstAmount;
    totalAmount += svc.amount;
    totalGst += gstAmount;
    
    html += `<tr>
      <td>${idx + 1}</td>
      <td>${svc.desc || 'N/A'}</td>
      <td>${svc.sac || 'NA'}</td>
      <td>${svc.quantity || 1}</td>
      <td>‚Çπ${(svc.rate || 0).toFixed(2)}</td>
      <td>‚Çπ${(svc.amount || 0).toFixed(2)}</td>
      <td>${svc.gst || 0}%</td>
      <td>‚Çπ${gstAmount.toFixed(2)}</td>
      <td>‚Çπ${total.toFixed(2)}</td>
    </tr>`;
  });

  const grandTotal = totalAmount + totalGst;
  html += `<tr class="invoice-total-row">
    <td colspan="5">TOTAL</td>
    <td>‚Çπ${totalAmount.toFixed(2)}</td>
    <td></td>
    <td>‚Çπ${totalGst.toFixed(2)}</td>
    <td>‚Çπ${grandTotal.toFixed(2)}</td>
  </tr></tbody></table>`;

  html += '<div style="margin-top: 15px; text-align: right;">';
  html += `<strong>Subtotal:</strong> ‚Çπ${totalAmount.toFixed(2)}<br>`;
  html += `<strong>GST:</strong> ‚Çπ${totalGst.toFixed(2)}<br>`;
  html += `<strong style="font-size: 14px; color: #1e40af;">Grand Total: ‚Çπ${grandTotal.toFixed(2)}</strong>`;
  html += '</div>';

  html += '<div style="margin-top: 20px; border-top: 1px solid #e2e8f0; padding-top: 15px; font-size: 10px; color: #718096;">';
  html += '<strong>Terms & Conditions:</strong><br>';
  html += 'Payment terms: As per agreement. This is a service invoice generated by Dream Harbour.<br>';
  html += 'GST is calculated on applicable services as per government guidelines.';
  html += '</div></div>';

  document.getElementById('invoicePreview').innerHTML = html;
}

function generateInvoicePDF() {
  const phone = document.getElementById('customerPhone').value;
  const name = document.getElementById('customerName').value;

  if (!phone || phone.length !== 10) {
    showError('Valid 10-digit phone number required');
    return;
  }
  if (!name) {
    showError('Customer name required');
    return;
  }
  if (invoiceData.services.length === 0) {
    showError('Add at least one service');
    return;
  }

  // Save customer
  const customers = JSON.parse(localStorage.getItem('customers') || '[]');
  const existingIdx = customers.findIndex(c => c.phone === phone);
  
  const customerData = {
    phone: phone,
    name: name,
    email: document.getElementById('customerEmail').value || '',
    gstin: document.getElementById('customerGstin').value || '',
    address: document.getElementById('customerAddress').value || ''
  };

  if (existingIdx >= 0) {
    customers[existingIdx] = customerData;
  } else {
    customers.push(customerData);
  }
  localStorage.setItem('customers', JSON.stringify(customers));

  // Generate invoice
  invoiceData.invoiceNumber = 'INV-' + Date.now();
  updateInvoicePreview();

  // Save invoice
  const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
  const totalAmt = invoiceData.services.reduce((sum, s) => sum + s.amount, 0);
  const totalGst = invoiceData.services.reduce((sum, s) => sum + (s.amount * s.gst / 100), 0);
  
  invoices.push({
    invoiceNumber: invoiceData.invoiceNumber,
    date: invoiceData.invoiceDate,
    customer: customerData,
    services: invoiceData.services,
    totalAmount: totalAmt,
    totalGst: totalGst,
    grandTotal: totalAmt + totalGst
  });
  localStorage.setItem('invoices', JSON.stringify(invoices));

  // Generate PDF
  const element = document.getElementById('invoicePreview');
  const opt = {
    margin: 10,
    filename: invoiceData.invoiceNumber + '.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
  };

  html2pdf().set(opt).from(element).save();
  showSuccess('Invoice generated, saved & downloaded');
  setTimeout(() => resetForm(), 2000);
}

function resetForm() {
  document.getElementById('customerPhone').value = '';
  document.getElementById('customerName').value = '';
  document.getElementById('customerEmail').value = '';
  document.getElementById('customerGstin').value = '';
  document.getElementById('customerAddress').value = '';
  document.getElementById('customerDropdown').style.display = 'none';
  invoiceData.services = [];
  invoiceData.invoiceNumber = null;
  resetServiceForm();
  document.getElementById('invoicePreview').innerHTML = '';
  document.getElementById('selectedServices').innerHTML = '';
}

function logout() {
  auth.signOut();
  window.location.href = '/';
}

firebase.auth().onAuthStateChanged(user => {
  if (!user) {
    window.location.href = '/';
  } else {
    currentUser = user;
  }
});
</script>

</body>
</html>
