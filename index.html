<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dream Harbour - Business Accounting</title>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root { --primary: #667eea; --secondary: #764ba2; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --dark: #1f2937; --light: #f9fafb; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--light); transition: all 0.3s; }
    body.dark-mode { background: var(--dark); color: #fff; }
    
    /* HEADER */
    .header { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; padding: 24px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .header h1 { font-size: 32px; margin-bottom: 4px; font-weight: 700; }
    .header p { font-size: 14px; opacity: 0.95; }
    
    /* CONTAINER */
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
    
    /* LOGIN */
    .login-container { background: white; border-radius: 20px; padding: 48px 32px; margin: 60px auto; max-width: 480px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.08); }
    body.dark-mode .login-container { background: #2d3748; }
    .login-container h1 { color: var(--dark); margin-bottom: 8px; font-size: 28px; }
    .login-container p { color: #666; margin-bottom: 32px; }
    
    input, select { width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 16px; margin-bottom: 16px; transition: all 0.3s; }
    body.dark-mode input, body.dark-mode select { background: #374151; color: white; border-color: #4b5563; }
    input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
    
    button { width: 100%; padding: 14px; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
    button:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); }
    button:active { transform: translateY(0); }
    
    .small-btn { width: auto; padding: 8px 16px; font-size: 13px; margin-right: 8px; margin-top: 8px; }
    
    /* TOP BAR */
    .top-bar { display: flex; justify-content: space-between; align-items: center; background: white; border-radius: 14px; padding: 20px 24px; margin-bottom: 32px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    body.dark-mode .top-bar { background: #2d3748; }
    .top-bar .user-info p { color: #666; margin: 4px 0; font-size: 14px; }
    body.dark-mode .top-bar .user-info p { color: #cbd5e0; }
    .role-badge { display: inline-block; padding: 6px 14px; background: var(--primary); color: white; border-radius: 20px; font-size: 12px; font-weight: 600; margin-left: 12px; }
    .logout-btn { background: var(--danger); width: auto; padding: 10px 24px; font-size: 14px; }
    
    /* DASHBOARD */
    .dashboard { display: none; }
    .dashboard.active { display: block; }
    
    /* CARDS GRID */
    .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 32px; }
    .card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: all 0.3s; }
    body.dark-mode .card { background: #2d3748; }
    .card:hover { transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
    .card h3 { color: var(--primary); font-size: 13px; text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.5px; }
    .card .amount { font-size: 36px; font-weight: 700; color: var(--dark); margin-bottom: 8px; }
    body.dark-mode .card .amount { color: white; }
    .card .subtitle { color: #999; font-size: 12px; }
    
    /* TABS */
    .tabs { display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid #e5e7eb; }
    body.dark-mode .tabs { border-bottom-color: #4b5563; }
    .tab-btn { padding: 12px 20px; background: none; border: none; color: #666; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; font-size: 15px; }
    body.dark-mode .tab-btn { color: #cbd5e0; }
    .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
    .tab-btn:hover { color: var(--primary); }
    
    /* TAB CONTENT */
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    /* FORMS */
    .form-area { background: white; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    body.dark-mode .form-area { background: #2d3748; }
    .form-area h3 { color: var(--dark); margin-bottom: 16px; font-size: 18px; }
    body.dark-mode .form-area h3 { color: white; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px; }
    
    /* TRANSACTION TABLE */
    .transaction-table { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    body.dark-mode .transaction-table { background: #2d3748; }
    .table-header { display: grid; grid-template-columns: 2fr 1.5fr 1fr 1fr; gap: 16px; padding: 16px 24px; background: #f9fafb; border-bottom: 2px solid #e5e7eb; font-weight: 600; color: #666; font-size: 13px; text-transform: uppercase; }
    body.dark-mode .table-header { background: #1f2937; border-bottom-color: #4b5563; color: #cbd5e0; }
    .table-row { display: grid; grid-template-columns: 2fr 1.5fr 1fr 1fr; gap: 16px; padding: 16px 24px; border-bottom: 1px solid #e5e7eb; align-items: center; transition: all 0.2s; }
    body.dark-mode .table-row { border-bottom-color: #4b5563; }
    .table-row:hover { background: #f9fafb; }
    body.dark-mode .table-row:hover { background: #374151; }
    .table-row:last-child { border-bottom: none; }
    .category-name { font-weight: 600; color: var(--dark); }
    body.dark-mode .category-name { color: white; }
    .amount.income { color: var(--success); font-weight: 700; }
    .amount.expense { color: var(--danger); font-weight: 700; }
    .table-date { color: #999; font-size: 13px; }
    .delete-btn { background: var(--danger); padding: 6px 12px; font-size: 12px; width: auto; }
    
    /* MESSAGES */
    .error { color: var(--danger); font-size: 14px; margin-top: 12px; }
    .success { color: var(--success); font-size: 14px; margin-top: 12px; }
    
    /* CHART */
    .chart-container { background: white; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    body.dark-mode .chart-container { background: #2d3748; }
    .chart-container h3 { color: var(--dark); margin-bottom: 20px; }
    body.dark-mode .chart-container h3 { color: white; }
    
    /* UTILITIES */
    .hidden { display: none !important; }
    .flex { display: flex; }
    .flex-between { display: flex; justify-content: space-between; align-items: center; }
    .margin-top { margin-top: 16px; }
    
    .mode-toggle { background: var(--primary); width: auto; padding: 8px 16px; font-size: 13px; position: fixed; bottom: 30px; right: 30px; border-radius: 50px; z-index: 999; }
    
    @media (max-width: 768px) {
      .cards-grid { grid-template-columns: 1fr; }
      .table-header, .table-row { grid-template-columns: 1fr; }
      .form-grid { grid-template-columns: 1fr; }
      .header h1 { font-size: 24px; }
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <div class="header">
    <h1>💼 Dream Harbour</h1>
    <p>Professional Business Accounting & Money Management</p>
  </div>

  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="login-container">
    <h1>Welcome Back</h1>
    <p>Smart accounting for modern business owners</p>
    <div id="loginSection">
      <input type="tel" id="phoneNumber" placeholder="+919999999999" />
      <div id="recaptcha-container"></div>
      <button onclick="sendOTP()">Send OTP</button>
      <div id="sendError" class="error"></div>
    </div>
    <div id="otpSection" class="hidden">
      <input type="text" id="otpCode" placeholder="Enter 6-digit OTP" maxlength="6" />
      <button onclick="verifyOTP()">Verify & Login</button>
      <div id="verifyError" class="error"></div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboardScreen" class="hidden">
    <div class="container">
      <!-- TOP BAR -->
      <div class="top-bar">
        <div class="user-info">
          <p><strong id="userPhoneDisplay"></strong></p>
          <span class="role-badge" id="roleDisplay"></span>
        </div>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>

      <!-- SUMMARY CARDS -->
      <div class="cards-grid">
        <div class="card">
          <h3>💰 Total Income</h3>
          <div class="amount" id="totalIncome">₹0</div>
          <div class="subtitle">All-time income</div>
        </div>
        <div class="card">
          <h3>💸 Total Expenses</h3>
          <div class="amount" id="totalExpense">₹0</div>
          <div class="subtitle">All-time expenses</div>
        </div>
        <div class="card">
          <h3>📊 Net Balance</h3>
          <div class="amount" id="netBalance">₹0</div>
          <div class="subtitle">Profit/Loss</div>
        </div>
      </div>

      <!-- MONTHLY SUMMARY -->
      <div class="cards-grid">
        <div class="card">
          <h3>📈 This Month Income</h3>
          <div class="amount" id="monthIncome">₹0</div>
        </div>
        <div class="card">
          <h3>📉 This Month Expense</h3>
          <div class="amount" id="monthExpense">₹0</div>
        </div>
        <div class="card">
          <h3>📋 This Month Balance</h3>
          <div class="amount" id="monthBalance">₹0</div>
        </div>
      </div>

      <!-- TABS -->
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('analytics')">📊 Analytics</button>
        <button class="tab-btn" onclick="switchTab('transactions')">📝 Transactions</button>
        <button class="tab-btn" onclick="switchTab('addTransaction')">➕ Add Transaction</button>
        <button class="tab-btn" onclick="switchTab('export')">💾 Export & Settings</button>
      </div>

      <!-- ANALYTICS TAB -->
      <div id="analytics" class="tab-content active">
        <div class="chart-container">
          <h3>Income vs Expense Overview</h3>
          <canvas id="overviewChart"></canvas>
        </div>
        <div class="chart-container">
          <h3>Monthly Trend</h3>
          <canvas id="trendChart"></canvas>
        </div>
        <div class="chart-container">
          <h3>Category Breakdown</h3>
          <canvas id="categoryChart"></canvas>
        </div>
      </div>

      <!-- TRANSACTIONS TAB -->
      <div id="transactions" class="tab-content">
        <div class="form-area">
          <input type="text" id="searchBox" placeholder="🔍 Search transactions by category or description..." style="margin-bottom: 16px;" onkeyup="filterTransactions()">
          <select id="filterMonth" onchange="filterTransactions()" style="margin-bottom: 16px;">
            <option value="">All Months</option>
            <option value="01">January</option>
            <option value="02">February</option>
            <option value="03">March</option>
            <option value="04">April</option>
            <option value="05">May</option>
            <option value="06">June</option>
            <option value="07">July</option>
            <option value="08">August</option>
            <option value="09">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
          </select>
        </div>
        <div class="transaction-table">
          <div class="table-header">
            <div>Category</div>
            <div>Description</div>
            <div>Amount</div>
            <div>Action</div>
          </div>
          <div id="transactionsList"></div>
        </div>
      </div>

      <!-- ADD TRANSACTION TAB -->
      <div id="addTransaction" class="tab-content">
        <div class="form-area">
          <h3>Add New Transaction</h3>
          <div class="form-grid">
            <select id="transactionType">
              <option value="income">➕ Income</option>
              <option value="expense">➖ Expense</option>
            </select>
            <input type="number" id="amount" placeholder="Amount" />
            <select id="category">
              <option value="">Select Category</option>
              <option value="Document Writing">Document Writing</option>
              <option value="E-Stamping">E-Stamping</option>
              <option value="Visa Services">Visa Services</option>
              <option value="Consultation">Consultation</option>
              <option value="Salary">Salary</option>
              <option value="Rent">Rent</option>
              <option value="Utilities">Utilities</option>
              <option value="Office Supplies">Office Supplies</option>
              <option value="Transport">Transport</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <input type="text" id="description" placeholder="Description (optional)" />
          <button onclick="addTransaction()" style="margin-top: 16px;">Add Transaction</button>
          <div id="transactionMessage"></div>
        </div>
      </div>

      <!-- EXPORT & SETTINGS TAB -->
      <div id="export" class="tab-content">
        <div class="form-area">
          <h3>📥 Export Data</h3>
          <button onclick="exportToCSV()" class="small-btn">📊 Export to CSV</button>
          <button onclick="exportToJSON()" class="small-btn">📄 Export to JSON</button>
          <button onclick="printReport()" class="small-btn">🖨️ Print Report</button>
          <div id="exportMessage"></div>
        </div>
        <div class="form-area">
          <h3>⚙️ Settings</h3>
          <button onclick="toggleDarkMode()" class="small-btn">🌙 Toggle Dark Mode</button>
          <button onclick="clearAllData()" class="small-btn" style="background: var(--warning);">🗑️ Clear All Data</button>
        </div>
      </div>
    </div>
  </div>

  <!-- DARK MODE TOGGLE -->
  <button class="mode-toggle" onclick="toggleDarkMode()" title="Toggle Dark Mode">🌙</button>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC-tQWS8o_Y7ZJtI3JjW9Uk4I9aHJ1ZDxs",
      authDomain: "dream-harbour.firebaseapp.com",
      projectId: "dream-harbour",
      storageBucket: "dream-harbour.firebasestorage.app",
      messagingSenderId: "857245144265",
      appId: "1:857245144265:web:6855412224da516592e918"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

    let confirmationResult, currentUser = null, userRole = null, allTransactions = [];
    let overviewChart, trendChart, categoryChart;

    function sendOTP() {
      const phoneNumber = document.getElementById('phoneNumber').value.trim();
      const sendError = document.getElementById('sendError');
      sendError.textContent = '';
      if (!phoneNumber) { sendError.textContent = "Please enter a phone number"; return; }
      const appVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { size: 'invisible' });
      auth.signInWithPhoneNumber(phoneNumber, appVerifier)
        .then((r) => { confirmationResult = r; document.getElementById('loginSection').classList.add('hidden'); document.getElementById('otpSection').classList.remove('hidden'); })
        .catch(error => { sendError.textContent = error.message; });
    }

    function verifyOTP() {
      const otp = document.getElementById('otpCode').value.trim();
      const verifyError = document.getElementById('verifyError');
      verifyError.textContent = '';
      if (!otp || otp.length !== 6) { verifyError.textContent = "Please enter a valid 6-digit OTP"; return; }
      confirmationResult.confirm(otp)
        .then(r => { currentUser = r.user; })
        .catch(error => { verifyError.textContent = "Invalid OTP"; });
    }

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        await loadUserRole();
        showDashboard();
      } else {
        showLogin();
      }
    });

    async function loadUserRole() {
      try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        if (userDoc.exists) {
          userRole = userDoc.data().role || 'owner';
        } else {
          await db.collection('users').doc(currentUser.uid).set({
            phone: currentUser.phoneNumber, role: 'owner', createdAt: new Date()
          });
          userRole = 'owner';
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

    function showDashboard() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('dashboardScreen').classList.remove('hidden');
      document.getElementById('userPhoneDisplay').textContent = currentUser.phoneNumber;
      document.getElementById('roleDisplay').textContent = "OWNER";
      loadAllData();
    }

    function showLogin() {
      document.getElementById('dashboardScreen').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');
    }

    async function loadAllData() {
      try {
        const snap = await db.collection('transactions').orderBy('date', 'desc').get();
        allTransactions = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        updateDashboard();
        updateCharts();
        displayTransactions();
      } catch (error) {
        console.error('Error loading data:', error);
      }
    }

    function updateDashboard() {
      let income = 0, expense = 0, monthIncome = 0, monthExpense = 0;
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();

      allTransactions.forEach(t => {
        const tDate = new Date(t.date.toDate ? t.date.toDate() : t.date);
        if (t.type === 'income') {
          income += t.amount;
          if (tDate.getMonth() === currentMonth && tDate.getFullYear() === currentYear) monthIncome += t.amount;
        } else {
          expense += t.amount;
          if (tDate.getMonth() === currentMonth && tDate.getFullYear() === currentYear) monthExpense += t.amount;
        }
      });

      document.getElementById('totalIncome').textContent = '₹' + income.toLocaleString();
      document.getElementById('totalExpense').textContent = '₹' + expense.toLocaleString();
      document.getElementById('netBalance').textContent = '₹' + (income - expense).toLocaleString();
      document.getElementById('monthIncome').textContent = '₹' + monthIncome.toLocaleString();
      document.getElementById('monthExpense').textContent = '₹' + monthExpense.toLocaleString();
      document.getElementById('monthBalance').textContent = '₹' + (monthIncome - monthExpense).toLocaleString();
    }

    function updateCharts() {
      const incomeExpenseData = { income: 0, expense: 0 };
      const monthlyData = {};
      const categoryData = {};

      allTransactions.forEach(t => {
        if (t.type === 'income') incomeExpenseData.income += t.amount;
        else incomeExpenseData.expense += t.amount;

        const date = t.date.toDate ? t.date.toDate() : new Date(t.date);
        const monthYear = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        if (!monthlyData[monthYear]) monthlyData[monthYear] = { income: 0, expense: 0 };
        if (t.type === 'income') monthlyData[monthYear].income += t.amount;
        else monthlyData[monthYear].expense += t.amount;

        if (!categoryData[t.category]) categoryData[t.category] = 0;
        categoryData[t.category] += t.amount;
      });

      // Overview Chart
      const ctx1 = document.getElementById('overviewChart');
      if (overviewChart) overviewChart.destroy();
      overviewChart = new Chart(ctx1, {
        type: 'doughnut',
        data: {
          labels: ['Income', 'Expense'],
          datasets: [{
            data: [incomeExpenseData.income, incomeExpenseData.expense],
            backgroundColor: ['#10b981', '#ef4444'],
            borderRadius: 6,
          }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });

      // Trend Chart
      const months = Object.keys(monthlyData);
      const ctx2 = document.getElementById('trendChart');
      if (trendChart) trendChart.destroy();
      trendChart = new Chart(ctx2, {
        type: 'line',
        data: {
          labels: months,
          datasets: [
            { label: 'Income', data: months.map(m => monthlyData[m].income), borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', tension: 0.4 },
            { label: 'Expense', data: months.map(m => monthlyData[m].expense), borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', tension: 0.4 }
          ]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });

      // Category Chart
      const ctx3 = document.getElementById('categoryChart');
      if (categoryChart) categoryChart.destroy();
      categoryChart = new Chart(ctx3, {
        type: 'bar',
        data: {
          labels: Object.keys(categoryData),
          datasets: [{
            label: 'Amount',
            data: Object.values(categoryData),
            backgroundColor: '#667eea',
            borderRadius: 6,
          }]
        },
        options: { responsive: true, indexAxis: 'y', plugins: { legend: { display: false } } }
      });
    }

    function displayTransactions() {
      let html = '';
      allTransactions.forEach(t => {
        const date = t.date.toDate ? t.date.toDate() : new Date(t.date);
        html += `
          <div class="table-row">
            <div class="category-name">${t.category}</div>
            <div>${t.description || '-'}</div>
            <div class="amount ${t.type}">${t.type === 'income' ? '+' : '-'} ₹${t.amount.toLocaleString()}</div>
            <div><button class="delete-btn" onclick="deleteTransaction('${t.id}')">🗑️ Delete</button></div>
          </div>
        `;
      });
      document.getElementById('transactionsList').innerHTML = html || '<div class="table-row">No transactions yet</div>';
    }

    function filterTransactions() {
      const search = document.getElementById('searchBox').value.toLowerCase();
      const month = document.getElementById('filterMonth').value;
      let filtered = allTransactions.filter(t => {
        const categoryMatch = t.category.toLowerCase().includes(search);
        const descriptionMatch = (t.description || '').toLowerCase().includes(search);
        const date = t.date.toDate ? t.date.toDate() : new Date(t.date);
        const monthMatch = !month || (date.getMonth() + 1).toString().padStart(2, '0') === month;
        return (categoryMatch || descriptionMatch) && monthMatch;
      });
      
      let html = '';
      filtered.forEach(t => {
        const date = t.date.toDate ? t.date.toDate() : new Date(t.date);
        html += `
          <div class="table-row">
            <div class="category-name">${t.category}</div>
            <div>${t.description || '-'}</div>
            <div class="amount ${t.type}">${t.type === 'income' ? '+' : '-'} ₹${t.amount.toLocaleString()}</div>
            <div><button class="delete-btn" onclick="deleteTransaction('${t.id}')">🗑️ Delete</button></div>
          </div>
        `;
      });
      document.getElementById('transactionsList').innerHTML = html || '<div class="table-row">No matching transactions</div>';
    }

    async function addTransaction() {
      const type = document.getElementById('transactionType').value;
      const amount = parseFloat(document.getElementById('amount').value);
      const category = document.getElementById('category').value;
      const description = document.getElementById('description').value;
      const msg = document.getElementById('transactionMessage');

      if (!amount || !category) { msg.textContent = '❌ Please fill all required fields'; msg.classList.add('error'); return; }

      try {
        await db.collection('transactions').add({
          userId: currentUser.uid, type, amount, category, description, date: new Date(), userPhone: currentUser.phoneNumber
        });
        msg.textContent = '✅ Transaction added successfully!';
        msg.classList.remove('error');
        msg.classList.add('success');
        document.getElementById('amount').value = '';
        document.getElementById('category').value = '';
        document.getElementById('description').value = '';
        setTimeout(() => { msg.textContent = ''; loadAllData(); }, 1500);
      } catch (error) {
        msg.textContent = '❌ Error: ' + error.message;
        msg.classList.add('error');
      }
    }

    async function deleteTransaction(id) {
      if (!confirm('Are you sure you want to delete this transaction?')) return;
      try {
        await db.collection('transactions').doc(id).delete();
        loadAllData();
      } catch (error) {
        alert('Error deleting transaction: ' + error.message);
      }
    }

    function switchTab(name) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(name).classList.add('active');
      event.target.classList.add('active');
    }

    function exportToCSV() {
      let csv = 'Category,Description,Type,Amount,Date\n';
      allTransactions.forEach(t => {
        const date = t.date.toDate ? t.date.toDate().toLocaleDateString() : new Date(t.date).toLocaleDateString();
        csv += `"${t.category}","${t.description || ''}","${t.type}","${t.amount}","${date}"\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'Dream_Harbour_Transactions.csv';
      a.click();
      document.getElementById('exportMessage').textContent = '✅ CSV exported successfully!';
      document.getElementById('exportMessage').classList.add('success');
      setTimeout(() => { document.getElementById('exportMessage').textContent = ''; }, 3000);
    }

    function exportToJSON() {
      const data = allTransactions.map(t => ({
        category: t.category,
        description: t.description || '',
        type: t.type,
        amount: t.amount,
        date: t.date.toDate ? t.date.toDate().toISOString() : t.date
      }));
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'Dream_Harbour_Transactions.json';
      a.click();
      document.getElementById('exportMessage').textContent = '✅ JSON exported successfully!';
      document.getElementById('exportMessage').classList.add('success');
      setTimeout(() => { document.getElementById('exportMessage').textContent = ''; }, 3000);
    }

    function printReport() {
      const printWindow = window.open('', '', 'width=800,height=600');
      let html = '<h2>Dream Harbour - Financial Report</h2>';
      html += '<table border="1" style="width:100%;"><tr><th>Category</th><th>Description</th><th>Type</th><th>Amount</th><th>Date</th></tr>';
      allTransactions.forEach(t => {
        const date = t.date.toDate ? t.date.toDate().toLocaleDateString() : new Date(t.date).toLocaleDateString();
        html += `<tr><td>${t.category}</td><td>${t.description || ''}</td><td>${t.type}</td><td>₹${t.amount}</td><td>${date}</td></tr>`;
      });
      html += '</table>';
      printWindow.document.write(html);
      printWindow.document.close();
      printWindow.print();
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    }

    function clearAllData() {
      if (!confirm('Are you SURE? This will delete ALL transactions and CANNOT be undone!')) return;
      db.collection('transactions').where('userId', '==', currentUser.uid).get().then(snap => {
        snap.forEach(doc => doc.ref.delete());
      });
      loadAllData();
    }

    function logout() {
      auth.signOut();
    }

    // Load dark mode preference
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark-mode');
    }
  </script>
</body>
</html>
