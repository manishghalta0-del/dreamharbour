<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dream Harbour - Expense Tracker</title>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: sans-serif; background: #f5f7fa; margin: 0; }
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center; padding: 20px;}
    .container { max-width: 1000px; margin: 30px auto; }
    .login-container { background: #fff; border-radius: 16px; padding: 40px; margin: 40px auto; max-width: 420px; text-align: center; }
    input, select { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; margin-bottom: 15px;}
    input:focus, select:focus { outline: none; border-color: #667eea;}
    button { width: 100%; padding: 14px; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color: #fff; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;}
    .top-bar { display: flex; justify-content: space-between; align-items: center; background: #fff; border-radius: 12px; margin-bottom: 24px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); padding: 20px;}
    .role-badge { display: inline-block; padding: 4px 12px; background: #667eea; color: white; border-radius: 20px; font-size: 12px; margin-left: 10px;}
    .logout-btn { background: #ef4444; width: auto; padding:10px 22px;}
    .hidden { display: none !important; }
    .cards { display: flex; gap: 16px; margin-bottom: 20px;}
    .card { flex:1; background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 2px 6px rgba(102,126,234,.07);}
    .card h2 { font-size: 15px; color: #667eea; }
    .card .amount { font-size: 28px; color: #333; font-weight: bold;}
    .tabs { display: flex; gap: 10px; margin-bottom: 20px;}
    .tab-btn { padding: 9px 18px; background: none; border: none; color: #666; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent;}
    .tab-btn.active { color: #667eea; border-bottom-color: #667eea; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .transaction-item { display: flex; justify-content: space-between; padding: 14px; border-bottom: 1px solid #f0f0f0;}
    .transaction-amount.income { color: #10b981;}
    .transaction-amount.expense { color: #ef4444;}
    .form-area { background: #fff; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.06); padding: 18px; margin-bottom: 22px;}
    .error { color: #ef4444; font-size: 14px;}
    .success { color: #10b981; font-size: 14px;}
    @media(max-width:600px) {.cards{flex-direction:column;}}
  </style>
</head>
<body>
  <div class="header">
    <h1>Dream Harbour</h1>
    <p>Smart Money Management for Modern Business</p>
  </div>
  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="login-container">
    <h1>Login</h1>
    <div id="loginSection">
      <input type="tel" id="phoneNumber" placeholder="+919999999999" />
      <div id="recaptcha-container"></div>
      <button onclick="sendOTP()">Send OTP</button>
      <div id="sendError" class="error"></div>
    </div>
    <div id="otpSection" class="hidden">
      <input type="text" id="otpCode" placeholder="Enter 6-digit OTP" maxlength="6" />
      <button onclick="verifyOTP()">Verify & Login</button>
      <div id="verifyError" class="error"></div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboardScreen" class="hidden">
    <div class="container">
      <!-- Top Bar -->
      <div class="top-bar">
        <div>
          <span id="userPhoneDisplay"></span>
          <span class="role-badge" id="roleDisplay"></span>
        </div>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>

      <!-- Owner Dashboard -->
      <div id="ownerDashboard" class="hidden">
        <div class="cards">
          <div class="card"><h2>Total Income</h2><div class="amount" id="totalIncome">₹0</div></div>
          <div class="card"><h2>Total Expenses</h2><div class="amount" id="totalExpense">₹0</div></div>
          <div class="card"><h2>Net Balance</h2><div class="amount" id="netBalance">₹0</div></div>
        </div>
        <div class="tabs">
          <button class="tab-btn active" onclick="switchTab('transactions')">Transactions</button>
          <button class="tab-btn" onclick="switchTab('employees')">Manage Employees</button>
        </div>
        <div id="transactions" class="tab-content active">
          <h3>All Transactions</h3>
          <div id="ownerTransactionsList"></div>
        </div>
        <div id="employees" class="tab-content">
          <h3>Manage Employees</h3>
          <input type="tel" id="employeePhone" placeholder="Employee Phone +919999999998" />
          <button onclick="assignRole()" style="margin-top:10px;">Assign as Employee</button>
          <div id="assignRoleMessage"></div>
          <div id="employeesList" style="margin-top:20px;"></div>
        </div>
      </div>

      <!-- Employee Dashboard -->
      <div id="employeeDashboard" class="hidden">
        <div class="cards">
          <div class="card"><h2>Your Income</h2><div class="amount" id="empTotalIncome">₹0</div></div>
          <div class="card"><h2>Your Expenses</h2><div class="amount" id="empTotalExpense">₹0</div></div>
          <div class="card"><h2>Your Balance</h2><div class="amount" id="empNetBalance">₹0</div></div>
        </div>
        <div class="form-area">
          <h3>Add Transaction</h3>
          <select id="transactionType">
            <option value="income">Income</option>
            <option value="expense">Expense</option>
          </select>
          <input type="number" id="amount" placeholder="Amount" />
          <input type="text" id="category" placeholder="Category" />
          <input type="text" id="description" placeholder="Description" />
          <button onclick="addTransaction()" style="margin-top:11px;">Add Transaction</button>
          <div id="transactionMessage"></div>
        </div>
        <div>
          <h3>Your Transactions</h3>
          <div id="employeeTransactionsList"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC-tQWS8o_Y7ZJtI3JjW9Uk4I9aHJ1ZDxs",
      authDomain: "dream-harbour.firebaseapp.com",
      projectId: "dream-harbour",
      storageBucket: "dream-harbour.firebasestorage.app",
      messagingSenderId: "857245144265",
      appId: "1:857245144265:web:6855412224da516592e918"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

    let confirmationResult, currentUser = null, userRole = null;

    function sendOTP() {
      const phoneNumber = document.getElementById('phoneNumber').value.trim();
      const sendError = document.getElementById('sendError');
      sendError.textContent = '';
      if (!phoneNumber) { sendError.textContent = "Please enter a phone number"; return; }
      const appVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container',{size: 'invisible'});
      auth.signInWithPhoneNumber(phoneNumber, appVerifier)
        .then((r) => { confirmationResult = r; document.getElementById('loginSection').classList.add('hidden'); document.getElementById('otpSection').classList.remove('hidden'); })
        .catch(error => { sendError.textContent = error.message; });
    }

    function verifyOTP() {
      const otp = document.getElementById('otpCode').value.trim();
      const verifyError = document.getElementById('verifyError');
      verifyError.textContent = '';
      if (!otp || otp.length !== 6) { verifyError.textContent = "Please enter a valid 6-digit OTP"; return; }
      confirmationResult.confirm(otp)
        .then(r => { currentUser = r.user; })
        .catch(error => { verifyError.textContent = "Invalid OTP"; });
    }

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        await loadUserRole();
        showDashboard();
      } else {
        showLogin();
      }
    });

    async function loadUserRole() {
      try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        if (userDoc.exists) {
          userRole = userDoc.data().role || 'pending';
        } else {
          await db.collection('users').doc(currentUser.uid).set({
            phone: currentUser.phoneNumber, role: 'pending', createdAt: new Date()
          });
          userRole = 'pending';
        }
      } catch (error) {
        alert("Error in loadUserRole: " + error.message);
      }
    }

    function showDashboard() {
      alert("Role detected: " + userRole);
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('dashboardScreen').classList.remove('hidden');
      document.getElementById('userPhoneDisplay').textContent = currentUser.phoneNumber;
      document.getElementById('roleDisplay').textContent = userRole.toUpperCase();
      if (userRole === 'owner') {
        document.getElementById('ownerDashboard').classList.remove('hidden');
        document.getElementById('employeeDashboard').classList.add('hidden');
        loadOwnerData();
      } else if (userRole === 'employee') {
        document.getElementById('employeeDashboard').classList.remove('hidden');
        document.getElementById('ownerDashboard').classList.add('hidden');
        loadEmployeeData();
      }
    }

    function showLogin() {
      document.getElementById('dashboardScreen').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');
    }

    async function loadOwnerData() {
      try {
        const snap = await db.collection('transactions').get();
        const transactions = snap.docs.map(doc => doc.data());
        let income = 0, expense = 0;
        transactions.forEach(t => { if (t.type === 'income') income += t.amount; if (t.type === 'expense') expense += t.amount; });
        document.getElementById('totalIncome').textContent = '₹' + income;
        document.getElementById('totalExpense').textContent = '₹' + expense;
        document.getElementById('netBalance').textContent = '₹' + (income - expense);
        let html = transactions.length ? '' : '<p>No transactions yet</p>';
        transactions.forEach(t => {
          html += `<div class="transaction-item"><div><strong>${t.category}</strong><br/><small>${t.description || ''}</small></div>
            <div class="transaction-amount ${t.type}">${t.type === 'income' ? '+' : '-'} ₹${t.amount}</div></div>`;
        });
        document.getElementById('ownerTransactionsList').innerHTML = html;
        loadEmployeesList();
      } catch (error) { alert("Error in loadOwnerData: " + error.message);}
    }

    async function loadEmployeeData() {
      try {
        const snap = await db.collection('transactions').where('userId', '==', currentUser.uid).get();
        const transactions = snap.docs.map(doc => doc.data());
        let income = 0, expense = 0;
        transactions.forEach(t => { if (t.type === 'income') income += t.amount; if (t.type === 'expense') expense += t.amount; });
        document.getElementById('empTotalIncome').textContent = '₹' + income;
        document.getElementById('empTotalExpense').textContent = '₹' + expense;
        document.getElementById('empNetBalance').textContent = '₹' + (income - expense);
        let html = transactions.length ? '' : '<p>No transactions yet</p>';
        transactions.forEach(t => {
          html += `<div class="transaction-item"><div><strong>${t.category}</strong><br/><small>${t.description || ''}</small></div>
            <div class="transaction-amount ${t.type}">${t.type === 'income' ? '+' : '-'} ₹${t.amount}</div></div>`;
        });
        document.getElementById('employeeTransactionsList').innerHTML = html;
      } catch (error) { alert("Error in loadEmployeeData: " + error.message);}
    }

    async function addTransaction() {
      const type = document.getElementById('transactionType').value;
      const amount = parseFloat(document.getElementById('amount').value);
      const category = document.getElementById('category').value, msg = document.getElementById('transactionMessage');
      if (!amount || !category) { msg.textContent = 'Fill all fields'; msg.classList.add('error'); return;}
      try {
        await db.collection('transactions').add({
          userId: currentUser.uid, type, amount, category, date: new Date(), userPhone: currentUser.phoneNumber
        });
        msg.textContent = '✅ Added!';
        msg.classList.add('success');
        document.getElementById('amount').value = '';
        document.getElementById('category').value = '';
        setTimeout(() => { msg.textContent = ''; loadEmployeeData(); }, 1500);
      } catch (error) { msg.textContent = 'Error: ' + error.message; msg.classList.add('error'); }
    }
    async function assignRole() {
      const phone = document.getElementById('employeePhone').value.trim();
      const msg = document.getElementById('assignRoleMessage');
      if (!phone) { msg.textContent = 'Enter phone number'; msg.style.color = '#ef4444'; return; }
      try {
        const snap = await db.collection('users').where('phone', '==', phone).get();
        if (snap.empty) { msg.textContent = 'User not found'; msg.style.color = '#ef4444'; return; }
        await db.collection('users').doc(snap.docs[0].id).update({ role: 'employee' });
        msg.textContent = '✅ Assigned!'; msg.style.color = '#10b981';
        document.getElementById('employeePhone').value = '';
        setTimeout(() => loadEmployeesList(), 1000);
      } catch (error) { msg.textContent = 'Error: ' + error.message; msg.style.color = '#ef4444'; }
    }
    async function loadEmployeesList() {
      try {
        const snap = await db.collection('users').where('role', '==', 'employee').get();
        let html = snap.empty ? '<p>No employees</p>' : '';
        snap.forEach(doc => { const e = doc.data(); html += `<div style="padding:10px; border-bottom:1px solid #eee;"><strong>${e.phone}</strong></div>`; });
        document.getElementById('employeesList').innerHTML = html;
      } catch (error) { alert("Error in loadEmployeesList: " + error.message);}
    }
    function switchTab(name) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(name).classList.add('active');
      event.target.classList.add('active');
    }
    function logout() { auth.signOut(); }
    // -- end script --
  </script>
</body>
</html>
