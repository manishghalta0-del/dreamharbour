<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dream Harbour - Enterprise Business Suite</title>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root { --primary: #667eea; --secondary: #764ba2; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --dark: #1f2937; --light: #f9fafb; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--light); transition: all 0.3s; overflow-x: hidden; }
    body.dark-mode { background: var(--dark); color: #fff; }
    
    /* HEADER */
    .header { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; padding: 24px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
    .header h1 { font-size: 32px; margin-bottom: 4px; font-weight: 700; }
    
    /* CONTAINER */
    .container { max-width: 1400px; margin: 0 auto; padding: 24px; }
    
    /* LOGIN */
    .login-container { background: white; border-radius: 20px; padding: 48px 32px; margin: 60px auto; max-width: 480px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.08); }
    body.dark-mode .login-container { background: #2d3748; }
    
    input, select, textarea { width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 16px; margin-bottom: 16px; transition: all 0.3s; font-family: inherit; }
    body.dark-mode input, body.dark-mode select, body.dark-mode textarea { background: #374151; color: white; border-color: #4b5563; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
    
    button { width: 100%; padding: 14px; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
    button:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); }
    
    .small-btn { width: auto; padding: 8px 16px; font-size: 13px; margin-right: 8px; margin-top: 8px; }
    
    /* TOP BAR */
    .top-bar { display: flex; justify-content: space-between; align-items: center; background: white; border-radius: 14px; padding: 20px 24px; margin-bottom: 32px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); flex-wrap: wrap; gap: 16px; }
    body.dark-mode .top-bar { background: #2d3748; }
    .role-badge { display: inline-block; padding: 6px 14px; background: var(--primary); color: white; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .logout-btn { background: var(--danger); width: auto; padding: 10px 24px; font-size: 14px; }
    
    /* DASHBOARD */
    .dashboard { display: none; }
    .dashboard.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    /* CARDS GRID */
    .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 32px; }
    .card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: all 0.3s; }
    body.dark-mode .card { background: #2d3748; }
    .card:hover { transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
    .card h3 { color: var(--primary); font-size: 13px; text-transform: uppercase; margin-bottom: 12px; }
    .card .amount { font-size: 32px; font-weight: 700; color: var(--dark); margin-bottom: 8px; }
    body.dark-mode .card .amount { color: white; }
    
    /* TABS */
    .tabs { display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid #e5e7eb; overflow-x: auto; padding-bottom: 12px; }
    body.dark-mode .tabs { border-bottom-color: #4b5563; }
    .tab-btn { padding: 12px 20px; background: none; border: none; color: #666; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; font-size: 15px; white-space: nowrap; }
    body.dark-mode .tab-btn { color: #cbd5e0; }
    .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
    
    /* TAB CONTENT */
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.3s; }
    
    /* FORMS */
    .form-area { background: white; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    body.dark-mode .form-area { background: #2d3748; }
    .form-area h3 { color: var(--dark); margin-bottom: 16px; font-size: 18px; }
    body.dark-mode .form-area h3 { color: white; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px; }
    
    /* TABLE */
    .table-container { background: white; border-radius: 12px; overflow-x: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    body.dark-mode .table-container { background: #2d3748; }
    .table-header { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px; padding: 16px 24px; background: #f9fafb; border-bottom: 2px solid #e5e7eb; font-weight: 600; color: #666; font-size: 13px; text-transform: uppercase; }
    body.dark-mode .table-header { background: #1f2937; border-bottom-color: #4b5563; color: #cbd5e0; }
    .table-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px; padding: 16px 24px; border-bottom: 1px solid #e5e7eb; align-items: center; }
    body.dark-mode .table-row { border-bottom-color: #4b5563; }
    .table-row:hover { background: #f9fafb; }
    body.dark-mode .table-row:hover { background: #374151; }
    
    /* MESSAGES */
    .error { color: var(--danger); font-size: 14px; margin-top: 12px; }
    .success { color: var(--success); font-size: 14px; margin-top: 12px; }
    
    /* CHART */
    .chart-container { background: white; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    body.dark-mode .chart-container { background: #2d3748; }
    
    .hidden { display: none !important; }
    .mode-toggle { background: var(--primary); width: auto; padding: 8px 16px; font-size: 13px; position: fixed; bottom: 30px; right: 30px; border-radius: 50px; z-index: 999; }
    
    /* INVOICE STYLES */
    .invoice-template { background: white; border-radius: 12px; padding: 40px; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 2px solid #e5e7eb; }
    .invoice-header { text-align: center; border-bottom: 3px solid var(--primary); padding-bottom: 20px; margin-bottom: 30px; }
    .invoice-number { font-size: 24px; font-weight: 700; color: var(--dark); margin-bottom: 10px; }
    .invoice-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    .invoice-table th { background: var(--primary); color: white; padding: 12px; text-align: left; font-weight: 600; }
    .invoice-table td { padding: 12px; border-bottom: 1px solid #e5e7eb; }
    .invoice-total { text-align: right; font-size: 20px; font-weight: 700; color: var(--success); margin-top: 20px; }
    
    @media (max-width: 768px) {
      .cards-grid { grid-template-columns: 1fr; }
      .form-grid { grid-template-columns: 1fr; }
      .header h1 { font-size: 24px; }
      .table-header, .table-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <div class="header">
    <h1>üíº Dream Harbour Enterprise</h1>
    <p>Complete Business Management Suite with Invoicing, Multi-Business Support & Advanced Analytics</p>
  </div>

  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="login-container">
    <h1>Welcome</h1>
    <p>Enterprise Business Accounting System</p>
    <div id="loginSection">
      <input type="tel" id="phoneNumber" placeholder="+919999999999" />
      <div id="recaptcha-container"></div>
      <button onclick="sendOTP()">Send OTP</button>
      <div id="sendError" class="error"></div>
    </div>
    <div id="otpSection" class="hidden">
      <input type="text" id="otpCode" placeholder="Enter 6-digit OTP" maxlength="6" />
      <button onclick="verifyOTP()">Verify & Login</button>
      <div id="verifyError" class="error"></div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboardScreen" class="hidden">
    <div class="container">
      <!-- TOP BAR -->
      <div class="top-bar">
        <div>
          <p><strong id="userPhoneDisplay"></strong></p>
          <span class="role-badge" id="roleDisplay"></span>
        </div>
        <div>
          <select id="businessSelector" onchange="switchBusiness()" style="width: auto; padding: 8px 12px;">
            <option value="">Select Business</option>
          </select>
        </div>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>

      <!-- SUMMARY CARDS -->
      <div class="cards-grid" id="summaryCards"></div>

      <!-- TABS -->
      <div class="tabs" id="tabsContainer"></div>

      <!-- TAB CONTENTS -->
      <div id="analytics" class="tab-content active">
        <div class="chart-container">
          <h3>Income vs Expense Overview</h3>
          <canvas id="overviewChart"></canvas>
        </div>
        <div class="chart-container">
          <h3>Monthly Trend</h3>
          <canvas id="trendChart"></canvas>
        </div>
        <div class="chart-container">
          <h3>Forecast (Next 3 Months)</h3>
          <canvas id="forecastChart"></canvas>
        </div>
      </div>

      <div id="invoices" class="tab-content">
        <div class="form-area">
          <h3>‚ûï Create Invoice</h3>
          <div class="form-grid">
            <select id="invoiceClient" onchange="populateInvoiceDetails()">
              <option value="">Select Client</option>
            </select>
            <input type="number" id="invoiceAmount" placeholder="Amount" />
            <input type="text" id="invoiceDescription" placeholder="Description" />
            <select id="invoiceStatus">
              <option value="pending">Pending</option>
              <option value="paid">Paid</option>
            </select>
          </div>
          <button onclick="createInvoice()" style="margin-top: 16px;">Create Invoice</button>
          <div id="invoiceMessage"></div>
        </div>
        <div class="table-container">
          <div class="table-header">
            <div>Invoice #</div>
            <div>Client</div>
            <div>Amount</div>
            <div>Status</div>
            <div>Date</div>
            <div>Action</div>
          </div>
          <div id="invoicesList"></div>
        </div>
      </div>

      <div id="clients" class="tab-content">
        <div class="form-area">
          <h3>‚ûï Add Client</h3>
          <div class="form-grid">
            <input type="text" id="clientName" placeholder="Client Name" />
            <input type="email" id="clientEmail" placeholder="Email" />
            <input type="tel" id="clientPhone" placeholder="Phone" />
            <input type="text" id="clientAddress" placeholder="Address" />
          </div>
          <button onclick="addClient()" style="margin-top: 16px;">Add Client</button>
          <div id="clientMessage"></div>
        </div>
        <div class="table-container">
          <div class="table-header">
            <div>Name</div>
            <div>Email</div>
            <div>Phone</div>
            <div>Address</div>
            <div>Action</div>
          </div>
          <div id="clientsList"></div>
        </div>
      </div>

      <div id="transactions" class="tab-content">
        <div class="form-area">
          <input type="text" id="searchBox" placeholder="üîç Search..." onkeyup="filterTransactions()">
          <select id="filterMonth" onchange="filterTransactions()" style="margin-bottom: 16px;">
            <option value="">All Months</option>
            <option value="01">January</option>
            <option value="02">February</option>
            <option value="03">March</option>
            <option value="04">April</option>
            <option value="05">May</option>
            <option value="06">June</option>
            <option value="07">July</option>
            <option value="08">August</option>
            <option value="09">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
          </select>
          <select id="filterTag" onchange="filterTransactions()" style="margin-bottom: 16px;">
            <option value="">All Tags</option>
            <option value="project">Project</option>
            <option value="client">Client</option>
            <option value="urgent">Urgent</option>
            <option value="recurring">Recurring</option>
          </select>
        </div>
        <div class="table-container">
          <div class="table-header">
            <div>Category</div>
            <div>Amount</div>
            <div>Tags</div>
            <div>Date</div>
            <div>Action</div>
          </div>
          <div id="transactionsList"></div>
        </div>
      </div>

      <div id="reports" class="tab-content">
        <div class="form-area">
          <h3>üìä Generate Report</h3>
          <div class="form-grid">
            <input type="date" id="reportStartDate" />
            <input type="date" id="reportEndDate" />
            <select id="reportType">
              <option value="summary">Summary Report</option>
              <option value="detailed">Detailed Report</option>
              <option value="pl">Profit & Loss</option>
            </select>
          </div>
          <button onclick="generateReport()" style="margin-top: 16px;">Generate Report</button>
          <button onclick="exportReportPDF()" class="small-btn" style="background: #667eea;">üì• Export as PDF</button>
          <div id="reportMessage"></div>
        </div>
        <div id="reportContent"></div>
      </div>

      <div id="settings" class="tab-content">
        <div class="form-area">
          <h3>‚öôÔ∏è Business Settings</h3>
          <input type="text" id="businessName" placeholder="Business Name" />
          <input type="email" id="businessEmail" placeholder="Business Email" />
          <input type="tel" id="businessPhone" placeholder="Business Phone" />
          <input type="text" id="businessAddress" placeholder="Business Address" />
          <textarea id="businessBankDetails" placeholder="Bank Details (for invoices)" style="height: 100px;"></textarea>
          <button onclick="saveBusiness Settings()" style="margin-top: 16px;">Save Settings</button>
          <div id="settingsMessage"></div>
        </div>
      </div>

      <div id="export" class="tab-content">
        <div class="form-area">
          <h3>üì• Export Data</h3>
          <button onclick="exportToCSV()" class="small-btn">üìä Export CSV</button>
          <button onclick="exportToJSON()" class="small-btn">üìÑ Export JSON</button>
          <button onclick="printReport()" class="small-btn">üñ®Ô∏è Print</button>
          <button onclick="clearAllData()" class="small-btn" style="background: var(--warning);">üóëÔ∏è Clear All</button>
          <div id="exportMessage"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- DARK MODE TOGGLE -->
  <button class="mode-toggle" onclick="toggleDarkMode()" title="Toggle Dark Mode">üåô</button>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC-tQWS8o_Y7ZJtI3JjW9Uk4I9aHJ1ZDxs",
      authDomain: "dream-harbour.firebaseapp.com",
      projectId: "dream-harbour",
      storageBucket: "dream-harbour.firebasestorage.app",
      messagingSenderId: "857245144265",
      appId: "1:857245144265:web:6855412224da516592e918"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

    let confirmationResult, currentUser = null, userRole = null;
    let currentBusiness = null, allBusinesses = [];
    let allTransactions = [], allClients = [], allInvoices = [];
    let overviewChart, trendChart, forecastChart;

    const tabs = ['analytics', 'invoices', 'clients', 'transactions', 'reports', 'settings', 'export'];

    function sendOTP() {
      const phoneNumber = document.getElementById('phoneNumber').value.trim();
      const sendError = document.getElementById('sendError');
      sendError.textContent = '';
      if (!phoneNumber) { sendError.textContent = "Enter phone"; return; }
      const appVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { size: 'invisible' });
      auth.signInWithPhoneNumber(phoneNumber, appVerifier)
        .then((r) => { confirmationResult = r; document.getElementById('loginSection').classList.add('hidden'); document.getElementById('otpSection').classList.remove('hidden'); })
        .catch(error => { sendError.textContent = error.message; });
    }

    function verifyOTP() {
      const otp = document.getElementById('otpCode').value.trim();
      const verifyError = document.getElementById('verifyError');
      verifyError.textContent = '';
      if (!otp || otp.length !== 6) { verifyError.textContent = "Invalid OTP"; return; }
      confirmationResult.confirm(otp)
        .then(r => { currentUser = r.user; })
        .catch(error => { verifyError.textContent = "Invalid OTP"; });
    }

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        await loadUserRole();
        await loadBusinesses();
        showDashboard();
      } else {
        showLogin();
      }
    });

    async function loadUserRole() {
      try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        if (userDoc.exists) {
          userRole = userDoc.data().role || 'owner';
        } else {
          await db.collection('users').doc(currentUser.uid).set({
            phone: currentUser.phoneNumber, role: 'owner', createdAt: new Date()
          });
          userRole = 'owner';
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

    async function loadBusinesses() {
      try {
        const snap = await db.collection('users').doc(currentUser.uid).collection('businesses').get();
        allBusinesses = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (allBusinesses.length === 0) {
          // Create default business
          await db.collection('users').doc(currentUser.uid).collection('businesses').add({
            name: 'Main Business', email: '', phone: '', address: '', bankDetails: '', createdAt: new Date()
          });
          await loadBusinesses();
          return;
        }
        populateBusinessSelector();
        currentBusiness = allBusinesses[0];
        await loadAllData();
      } catch (error) {
        console.error('Error:', error);
      }
    }

    function populateBusinessSelector() {
      const selector = document.getElementById('businessSelector');
      selector.innerHTML = '<option value="">Select Business</option>';
      allBusinesses.forEach(b => {
        selector.innerHTML += `<option value="${b.id}">${b.name}</option>`;
      });
    }

    async function switchBusiness() {
      const bizId = document.getElementById('businessSelector').value;
      if (bizId) {
        currentBusiness = allBusinesses.find(b => b.id === bizId);
        await loadAllData();
      }
    }

    function showDashboard() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('dashboardScreen').classList.remove('hidden');
      document.getElementById('userPhoneDisplay').textContent = currentUser.phoneNumber;
      document.getElementById('roleDisplay').textContent = "OWNER";
      createTabs();
    }

    function showLogin() {
      document.getElementById('dashboardScreen').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');
    }

    function createTabs() {
      const container = document.getElementById('tabsContainer');
      container.innerHTML = '';
      tabs.forEach(tab => {
        const btn = document.createElement('button');
        btn.className = 'tab-btn' + (tab === 'analytics' ? ' active' : '');
        btn.textContent = getTabLabel(tab);
        btn.onclick = () => switchTab(tab);
        container.appendChild(btn);
      });
    }

    function getTabLabel(tab) {
      const labels = {
        analytics: 'üìä Analytics',
        invoices: 'üìÑ Invoices',
        clients: 'üë• Clients',
        transactions: 'üìù Transactions',
        reports: 'üìã Reports',
        settings: '‚öôÔ∏è Settings',
        export: 'üíæ Export'
      };
      return labels[tab] || tab;
    }

    function switchTab(name) {
      tabs.forEach(tab => {
        document.getElementById(tab).classList.remove('active');
      });
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(name).classList.add('active');
      event.target.classList.add('active');
      
      if (name === 'analytics') updateCharts();
    }

    async function loadAllData() {
      await loadTransactions();
      await loadClients();
      await loadInvoices();
      updateSummaryCards();
      displayTransactions();
      displayClients();
      displayInvoices();
      updateCharts();
    }

    async function loadTransactions() {
      try {
        const snap = await db.collection('users').doc(currentUser.uid).collection('businesses').doc(currentBusiness.id).collection('transactions').orderBy('date', 'desc').get();
        allTransactions = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } catch (error) {
        console.error('Error:', error);
        allTransactions = [];
      }
    }

    async function loadClients() {
      try {
        const snap = await db.collection('users').doc(currentUser.uid).collection('businesses').doc(currentBusiness.id).collection('clients').get();
        allClients = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        populateClientSelector();
      } catch (error) {
        console.error('Error:', error);
        allClients = [];
      }
    }

    async function loadInvoices() {
      try {
        const snap = await db.collection('users').doc(currentUser.uid).collection('businesses').doc(currentBusiness.id).collection('invoices').orderBy('date', 'desc').get();
        allInvoices = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } catch (error) {
        console.error('Error:', error);
        allInvoices = [];
      }
    }

    function populateClientSelector() {
      const selector = document.getElementById('invoiceClient');
      selector.innerHTML = '<option value="">Select Client</option>';
      allClients.forEach(c => {
        selector.innerHTML += `<option value="${c.id}">${c.name}</option>`;
      });
    }

    function updateSummaryCards() {
      let income = 0, expense = 0, pendingInvoices = 0, paidInvoices = 0;
      allTransactions.forEach(t => {
        if (t.type === 'income') income += t.amount;
        else expense += t.amount;
      });
      allInvoices.forEach(inv => {
        if (inv.status === 'pending') pendingInvoices += inv.amount;
        else paidInvoices += inv.amount;
      });

      document.getElementById('summaryCards').innerHTML = `
        <div class="card"><h3>üí∞ Total Income</h3><div class="amount">‚Çπ${income.toLocaleString()}</div></div>
        <div class="card"><h3>üí∏ Total Expenses</h3><div class="amount">‚Çπ${expense.toLocaleString()}</div></div>
        <div class="card"><h3>üìä Net Balance</h3><div class="amount">‚Çπ${(income - expense).toLocaleString()}</div></div>
        <div class="card"><h3>‚è≥ Pending Invoices</h3><div class="amount">‚Çπ${pendingInvoices.toLocaleString()}</div></div>
        <div class="card"><h3>‚úÖ Paid Invoices</h3><div class="amount">‚Çπ${paidInvoices.toLocaleString()}</div></div>
      `;
    }

    function updateCharts() {
      const incomeExpenseData = { income: 0, expense: 0 };
      const monthlyData = {};
      const monthlyForecast = {};

      allTransactions.forEach(t => {
        if (t.type === 'income') incomeExpenseData.income += t.amount;
        else incomeExpenseData.expense += t.amount;
        
        const date = t.date.toDate ? t.date.toDate() : new Date(t.date);
        const monthYear = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        if (!monthlyData[monthYear]) monthlyData[monthYear] = { income: 0, expense: 0 };
        if (t.type === 'income') monthlyData[monthYear].income += t.amount;
        else monthlyData[monthYear].expense += t.amount;
      });

      // Simple forecast (average last 3 months * next 3 months)
      const months = Object.keys(monthlyData).slice(-3);
      const avgIncome = months.reduce((sum, m) => sum + monthlyData[m].income, 0) / 3;
      const avgExpense = months.reduce((sum, m) => sum + monthlyData[m].expense, 0) / 3;
      for (let i = 1; i <= 3; i++) {
        monthlyForecast[`+${i}M`] = { income: avgIncome, expense: avgExpense };
      }

      // Overview Chart
      const ctx1 = document.getElementById('overviewChart');
      if (overviewChart) overviewChart.destroy();
      overviewChart = new Chart(ctx1, {
        type: 'doughnut',
        data: {
          labels: ['Income', 'Expense'],
          datasets: [{
            data: [incomeExpenseData.income, incomeExpenseData.expense],
            backgroundColor: ['#10b981', '#ef4444'],
            borderRadius: 6,
          }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });

      // Trend Chart
      const monthLabels = Object.keys(monthlyData);
      const ctx2 = document.getElementById('trendChart');
      if (trendChart) trendChart.destroy();
      trendChart = new Chart(ctx2, {
        type: 'line',
        data: {
          labels: monthLabels,
          datasets: [
            { label: 'Income', data: monthLabels.map(m => monthlyData[m].income), borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', tension: 0.4 },
            { label: 'Expense', data: monthLabels.map(m => monthlyData[m].expense), borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', tension: 0.4 }
          ]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });

      // Forecast Chart
      const forecastLabels = Object.keys(monthlyForecast);
      const ctx3 = document.getElementById('forecastChart');
      if (forecastChart) forecastChart.destroy();
      forecastChart = new Chart(ctx3, {
        type: 'bar',
        data: {
          labels: forecastLabels,
          datasets: [
            { label: 'Predicted Income', data: forecastLabels.map(m => monthlyForecast[m].income), backgroundColor: '#10b981' },
            { label: 'Predicted Expense', data: forecastLabels.map(m => monthlyForecast[m].expense), backgroundColor: '#ef4444' }
          ]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });
    }

    async function addClient() {
      const name = document.getElementById('clientName').value;
      const email = document.getElementById('clientEmail').value;
      const phone = document.getElementById('clientPhone').value;
      const address = document.getElementById('clientAddress').value;
      const msg = document.getElementById('clientMessage');

      if (!name) { msg.textContent = '‚ùå Enter client name'; msg.classList.add('error'); return; }

      try {
        await db.collection('users').doc(currentUser.uid).collection('businesses').doc(currentBusiness.id).collection('clients').add({
          name, email, phone, address, createdAt: new Date()
        });
        msg.textContent = '‚úÖ Client added!';
        msg.classList.add('success');
        document.getElementById('clientName').value = '';
        document.getElementById('clientEmail').value = '';
        document.getElementById('clientPhone').value = '';
        document.getElementById('clientAddress').value = '';
        setTimeout(() => { msg.textContent = ''; loadClients(); }, 1500);
      } catch (error) {
        msg.textContent = '‚ùå Error: ' + error.message;
        msg.classList.add('error');
      }
    }

    function displayClients() {
      let html = '';
      allClients.forEach(c => {
        html += `
          <div class="table-row">
            <div>${c.name}</div>
            <div>${c.email || '-'}</div>
            <div>${c.phone || '-'}</div>
            <div>${c.address || '-'}</div>
            <div><button class="small-btn" onclick="deleteClient('${c.id}')">Delete</button></div>
          </div>
        `;
      });
      document.getElementById('clientsList').innerHTML = html || '<div class="table-row">No clients yet</div>';
    }

    async function deleteClient(id) {
      if (!confirm('Delete this client?')) return;
      try {
        await db.collection('users').doc(currentUser.uid).collection('businesses').doc(currentBusiness.id).collection('clients').doc(id).delete();
        loadClients();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function createInvoice() {
      const clientId = document.getElementById('invoiceClient').value;
      const amount = parseFloat(document.getElementById('invoiceAmount').value);
      const description = document.getElementById('invoiceDescription').value;
      const status = document.getElementById('invoiceStatus').value;
      const msg = document.getElementById('invoiceMessage');

      if (!clientId || !amount) { msg.textContent = '‚ùå Fill all fields'; msg.classList.add('error'); return; }

      try {
        const client = allClients.find(c => c.id === clientId);
        const invoiceNum = 'INV-' + Date.now();
        await db.collection('users').doc(currentUser.uid).collection('businesses').doc(currentBusiness.id).collection('invoices').add({
          invoiceNumber: invoiceNum,
          clientId, clientName: client.name,
          amount, description, status,
          date: new Date(),
          createdAt: new Date()
        });
        msg.textContent = '‚úÖ Invoice created!';
        msg.classList.add('success');
        setTimeout(() => { msg.textContent = ''; loadInvoices(); }, 1500);
      } catch (error) {
        msg.textContent = '‚ùå Error: ' + error.message;
        msg.classList.add('error');
      }
    }

    function displayInvoices() {
      let html = '';
      allInvoices.forEach(inv => {
        const date = inv.date.toDate ? inv.date.toDate().toLocaleDateString() : new Date(inv.date).toLocaleDateString();
        html += `
          <div class="table-row">
            <div><strong>${inv.invoiceNumber}</strong></div>
            <div>${inv.clientName}</div>
            <div>‚Çπ${inv.amount}</div>
            <div><span style="padding: 4px 8px; border-radius: 4px; background: ${inv.status === 'paid' ? '#10b981' : '#f59e0b'}; color: white; font-size: 12px;">${inv.status}</span></div>
            <div>${date}</div>
            <div><button class="small-btn" onclick="downloadInvoice('${inv.id}')">PDF</button></div>
          </div>
        `;
      });
      document.getElementById('invoicesList').innerHTML = html || '<div class="table-row">No invoices yet</div>';
    }

    async function downloadInvoice(id) {
      const invoice = allInvoices.find(inv => inv.id === id);
      if (!invoice) return;

      const element = document.createElement('div');
      element.innerHTML = `
        <div style="padding: 40px; border: 2px solid #667eea;">
          <div style="text-align: center; border-bottom: 3px solid #667eea; padding-bottom: 20px; margin-bottom: 30px;">
            <h2>${currentBusiness.name}</h2>
            <p>${invoice.invoiceNumber}</p>
          </div>
          <p><strong>Bill To:</strong> ${invoice.clientName}</p>
          <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
            <tr>
              <th style="border: 1px solid #ddd; padding: 10px; background: #f0f0f0;">Description</th>
              <th style="border: 1px solid #ddd; padding: 10px; background: #f0f0f0;">Amount</th>
            </tr>
            <tr>
              <td style="border: 1px solid #ddd; padding: 10px;">${invoice.description}</td>
              <td style="border: 1px solid #ddd; padding: 10px;">‚Çπ${invoice.amount}</td>
            </tr>
          </table>
          <p style="text-align: right; font-size: 18px; font-weight: bold; color: #10b981;">Total: ‚Çπ${invoice.amount}</p>
          <p style="text-align: right; margin-top: 20px; color: ${invoice.status === 'paid' ? '#10b981' : '#f59e0b'};">Status: ${invoice.status.toUpperCase()}</p>
        </div>
      `;

      const opt = {
        margin: 10,
        filename: `${invoice.invoiceNumber}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
      };

      html2pdf().set(opt).from(element).save();
    }

    function displayTransactions() {
      let html = '';
      allTransactions.forEach(t => {
        const date = t.date.toDate ? t.date.toDate().toLocaleDateString() : new Date(t.date).toLocaleDateString();
        html += `
          <div class="table-row">
            <div><strong>${t.category}</strong></div>
            <div style="color: ${t.type === 'income' ? '#10b981' : '#ef4444'}; font-weight: 700;">
              ${t.type === 'income' ? '+' : '-'} ‚Çπ${t.amount}
            </div>
            <div>${t.tags ? t.tags.join(', ') : '-'}</div>
            <div>${date}</div>
            <div><button class="small-btn" onclick="deleteTransaction('${t.id}')">Delete</button></div>
          </div>
        `;
      });
      document.getElementById('transactionsList').innerHTML = html || '<div class="table-row">No transactions yet</div>';
    }

    async function deleteTransaction(id) {
      if (!confirm('Delete transaction?')) return;
      try {
        await db.collection('users').doc(currentUser.uid).collection('businesses').doc(currentBusiness.id).collection('transactions').doc(id).delete();
        loadTransactions();
        updateSummaryCards();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    function filterTransactions() {
      const search = document.getElementById('searchBox').value.toLowerCase();
      const month = document.getElementById('filterMonth').value;
      const tag = document.getElementById('filterTag').value;
      
      let filtered = allTransactions.filter(t => {
        const categoryMatch = t.category.toLowerCase().includes(search);
        const date = t.date.toDate ? t.date.toDate() : new Date(t.date);
        const monthMatch = !month || (date.getMonth() + 1).toString().padStart(2, '0') === month;
        const tagMatch = !tag || (t.tags && t.tags.includes(tag));
        return (categoryMatch) && monthMatch && tagMatch;
      });

      let html = '';
      filtered.forEach(t => {
        const date = t.date.toDate ? t.date.toDate().toLocaleDateString() : new Date(t.date).toLocaleDateString();
        html += `
          <div class="table-row">
            <div><strong>${t.category}</strong></div>
            <div style="color: ${t.type === 'income' ? '#10b981' : '#ef4444'}; font-weight: 700;">
              ${t.type === 'income' ? '+' : '-'} ‚Çπ${t.amount}
            </div>
            <div>${t.tags ? t.tags.join(', ') : '-'}</div>
            <div>${date}</div>
            <div><button class="small-btn" onclick="deleteTransaction('${t.id}')">Delete</button></div>
          </div>
        `;
      });
      document.getElementById('transactionsList').innerHTML = html || '<div class="table-row">No matching transactions</div>';
    }

    async function generateReport() {
      const startDate = new Date(document.getElementById('reportStartDate').value);
      const endDate = new Date(document.getElementById('reportEndDate').value);
      const reportType = document.getElementById('reportType').value;

      if (!startDate || !endDate) { alert('Select dates'); return; }

      let html = '<div class="form-area"><h3>Report: ' + startDate.toLocaleDateString() + ' to ' + endDate.toLocaleDateString() + '</h3>';

      let income = 0, expense = 0;
      const filtered = allTransactions.filter(t => {
        const d = t.date.toDate ? t.date.toDate() : new Date(t.date);
        return d >= startDate && d <= endDate;
      });

      filtered.forEach(t => {
        if (t.type === 'income') income += t.amount;
        else expense += t.amount;
      });

      html += `<p><strong>Total Income:</strong> ‚Çπ${income}</p>`;
      html += `<p><strong>Total Expense:</strong> ‚Çπ${expense}</p>`;
      html += `<p><strong>Net Profit:</strong> ‚Çπ${income - expense}</p>`;

      if (reportType === 'pl') {
        html += `<p><strong>Profit Margin:</strong> ${((income - expense) / income * 100).toFixed(2)}%</p>`;
      }

      if (reportType === 'detailed') {
        html += '<h4>Transactions</h4>';
        filtered.forEach(t => {
          html += `<p>${t.category}: ${t.type === 'income' ? '+' : '-'} ‚Çπ${t.amount}</p>`;
        });
      }

      html += '</div>';
      document.getElementById('reportContent').innerHTML = html;
    }

    function exportReportPDF() {
      const element = document.getElementById('reportContent');
      if (!element.innerHTML) { alert('Generate report first'); return; }
      const opt = {
        margin: 10,
        filename: 'Dream_Harbour_Report.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
      };
      html2pdf().set(opt).from(element).save();
    }

    async function saveBusiness Settings() {
      const name = document.getElementById('businessName').value;
      const email = document.getElementById('businessEmail').value;
      const phone = document.getElementById('businessPhone').value;
      const address = document.getElementById('businessAddress').value;
      const bankDetails = document.getElementById('businessBankDetails').value;
      const msg = document.getElementById('settingsMessage');

      try {
        await db.collection('users').doc(currentUser.uid).collection('businesses').doc(currentBusiness.id).update({
          name, email, phone, address, bankDetails
        });
        msg.textContent = '‚úÖ Settings saved!';
        msg.classList.add('success');
        setTimeout(() => { msg.textContent = ''; }, 2000);
      } catch (error) {
        msg.textContent = '‚ùå Error: ' + error.message;
        msg.classList.add('error');
      }
    }

    function exportToCSV() {
      let csv = 'Category,Amount,Type,Tags,Date\n';
      allTransactions.forEach(t => {
        const date = t.date.toDate ? t.date.toDate().toLocaleDateString() : new Date(t.date).toLocaleDateString();
        csv += `"${t.category}","${t.amount}","${t.type}","${(t.tags || []).join(';')}","${date}"\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'Dream_Harbour_Data.csv';
      a.click();
    }

    function exportToJSON() {
      const data = { business: currentBusiness, transactions: allTransactions, clients: allClients, invoices: allInvoices };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'Dream_Harbour_Data.json';
      a.click();
    }

    function printReport() {
      window.print();
    }

    function clearAllData() {
      if (!confirm('PERMANENTLY DELETE ALL DATA?')) return;
      // Implementation: delete all collections for this business
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    }

    function logout() {
      auth.signOut();
    }

    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark-mode');
    }
  </script>
      // ============ FIREBASE CONFIG ============
    const firebaseConfig = {
      apiKey: "AIzaSyC-tQWS8o_Y7ZJtI3JjW9Uk4I9aHJ1ZDxs",
      authDomain: "dream-harbour.firebaseapp.com",
      projectId: "dream-harbour",
      storageBucket: "dream-harbour.firebasestorage.app",
      messagingSenderId: "857245144265",
      appId: "1:857245144265:web:6855412224da516592e918"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

    // ============ GLOBAL VARIABLES ============
    let confirmationResult, currentUser = null, userRole = null;
    let currentBusiness = null, allBusinesses = [];
    let allTransactions = [], allClients = [], allInvoices = [];
    let overviewChart, trendChart, forecastChart;
    let recurringTransactions = [];

    const tabs = ['analytics', 'invoices', 'clients', 'transactions', 'reports', 'settings', 'export'];

    // ============ AUTHENTICATION ============
    function sendOTP() {
      const phoneNumber = document.getElementById('phoneNumber').value.trim();
      const sendError = document.getElementById('sendError');
      sendError.textContent = '';
      if (!phoneNumber) { sendError.textContent = "Enter phone number"; return; }
      const appVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { size: 'invisible' });
      auth.signInWithPhoneNumber(phoneNumber, appVerifier)
        .then((r) => { 
          confirmationResult = r; 
          document.getElementById('loginSection').classList.add('hidden'); 
          document.getElementById('otpSection').classList.remove('hidden'); 
        })
        .catch(error => { sendError.textContent = error.message; });
    }

    function verifyOTP() {
      const otp = document.getElementById('otpCode').value.trim();
      const verifyError = document.getElementById('verifyError');
      verifyError.textContent = '';
      if (!otp || otp.length !== 6) { verifyError.textContent = "Invalid OTP"; return; }
      confirmationResult.confirm(otp)
        .then(r => { currentUser = r.user; })
        .catch(error => { verifyError.textContent = "Invalid OTP"; });
    }

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        await loadUserRole();
        await loadBusinesses();
        showDashboard();
      } else {
        showLogin();
      }
    });

    // ============ USER & BUSINESS MANAGEMENT ============
    async function loadUserRole() {
      try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        if (userDoc.exists) {
          userRole = userDoc.data().role || 'owner';
        } else {
          await db.collection('users').doc(currentUser.uid).set({
            phone: currentUser.phoneNumber, 
            role: 'owner', 
            createdAt: new Date()
          });
          userRole = 'owner';
        }
      } catch (error) {
        console.error('Error loading role:', error);
      }
    }

    async function loadBusinesses() {
      try {
        const snap = await db.collection('users').doc(currentUser.uid).collection('businesses').get();
        allBusinesses = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        if (allBusinesses.length === 0) {
          await createDefaultBusiness();
          await loadBusinesses();
          return;
        }
        
        populateBusinessSelector();
        currentBusiness = allBusinesses[0];
        await loadAllData();
      } catch (error) {
        console.error('Error loading businesses:', error);
        allBusinesses = [];
      }
    }

    async function createDefaultBusiness() {
      try {
        await db.collection('users').doc(currentUser.uid).collection('businesses').add({
          name: 'Main Business',
          email: '',
          phone: '',
          address: '',
          bankDetails: '',
          createdAt: new Date()
        });
      } catch (error) {
        console.error('Error creating business:', error);
      }
    }

    function populateBusinessSelector() {
      const selector = document.getElementById('businessSelector');
      selector.innerHTML = '<option value="">Select Business</option>';
      allBusinesses.forEach(b => {
        selector.innerHTML += `<option value="${b.id}">${b.name}</option>`;
      });
    }

    async function switchBusiness() {
      const bizId = document.getElementById('businessSelector').value;
      if (bizId) {
        currentBusiness = allBusinesses.find(b => b.id === bizId);
        await loadAllData();
      }
    }

    function showDashboard() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('dashboardScreen').classList.remove('hidden');
      document.getElementById('userPhoneDisplay').textContent = currentUser.phoneNumber;
      document.getElementById('roleDisplay').textContent = "OWNER";
      createTabs();
      processRecurringTransactions();
    }

    function showLogin() {
      document.getElementById('dashboardScreen').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');
    }

    // ============ TABS MANAGEMENT ============
    function createTabs() {
      const container = document.getElementById('tabsContainer');
      container.innerHTML = '';
      tabs.forEach(tab => {
        const btn = document.createElement('button');
        btn.className = 'tab-btn' + (tab === 'analytics' ? ' active' : '');
        btn.textContent = getTabLabel(tab);
        btn.onclick = () => switchTab(tab);
        container.appendChild(btn);
      });
    }

    function getTabLabel(tab) {
      const labels = {
        analytics: 'üìä Analytics',
        invoices: 'üìÑ Invoices',
        clients: 'üë• Clients',
        transactions: 'üìù Transactions',
        reports: 'üìã Reports',
        settings: '‚öôÔ∏è Settings',
        export: 'üíæ Export'
      };
      return labels[tab] || tab;
    }

    function switchTab(name) {
      tabs.forEach(tab => {
        document.getElementById(tab).classList.remove('active');
      });
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(name).classList.add('active');
      event.target.classList.add('active');
      
      if (name === 'analytics') updateCharts();
    }

    // ============ DATA LOADING ============
    async function loadAllData() {
      await loadTransactions();
      await loadClients();
      await loadInvoices();
      await loadRecurringTransactions();
      updateSummaryCards();
      displayTransactions();
      displayClients();
      displayInvoices();
      updateCharts();
    }

    async function loadTransactions() {
      try {
        const snap = await db.collection('users').doc(currentUser.uid)
          .collection('businesses').doc(currentBusiness.id)
          .collection('transactions').orderBy('date', 'desc').get();
        allTransactions = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } catch (error) {
        console.error('Error:', error);
        allTransactions = [];
      }
    }

    async function loadClients() {
      try {
        const snap = await db.collection('users').doc(currentUser.uid)
          .collection('businesses').doc(currentBusiness.id)
          .collection('clients').get();
        allClients = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        populateClientSelector();
      } catch (error) {
        console.error('Error:', error);
        allClients = [];
      }
    }

    async function loadInvoices() {
      try {
        const snap = await db.collection('users').doc(currentUser.uid)
          .collection('businesses').doc(currentBusiness.id)
          .collection('invoices').orderBy('date', 'desc').get();
        allInvoices = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } catch (error) {
        console.error('Error:', error);
        allInvoices = [];
      }
    }

    async function loadRecurringTransactions() {
      try {
        const snap = await db.collection('users').doc(currentUser.uid)
          .collection('businesses').doc(currentBusiness.id)
          .collection('recurringTransactions').get();
        recurringTransactions = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } catch (error) {
        console.error('Error:', error);
        recurringTransactions = [];
      }
    }

    // ============ SUMMARY & CHARTS ============
    function updateSummaryCards() {
      let income = 0, expense = 0, pendingInvoices = 0, paidInvoices = 0, totalClients = allClients.length;
      
      allTransactions.forEach(t => {
        if (t.type === 'income') income += t.amount;
        else expense += t.amount;
      });
      
      allInvoices.forEach(inv => {
        if (inv.status === 'pending') pendingInvoices += inv.amount;
        else paidInvoices += inv.amount;
      });

      document.getElementById('summaryCards').innerHTML = `
        <div class="card"><h3>üí∞ Total Income</h3><div class="amount">‚Çπ${income.toLocaleString()}</div></div>
        <div class="card"><h3>üí∏ Total Expenses</h3><div class="amount">‚Çπ${expense.toLocaleString()}</div></div>
        <div class="card"><h3>üìä Net Profit</h3><div class="amount" style="color: ${income - expense >= 0 ? '#10b981' : '#ef4444'};">‚Çπ${(income - expense).toLocaleString()}</div></div>
        <div class="card"><h3>‚è≥ Pending Invoices</h3><div class="amount">‚Çπ${pendingInvoices.toLocaleString()}</div></div>
        <div class="card"><h3>‚úÖ Paid Invoices</h3><div class="amount">‚Çπ${paidInvoices.toLocaleString()}</div></div>
        <div class="card"><h3>üë• Total Clients</h3><div class="amount">${totalClients}</div></div>
      `;
    }

    function updateCharts() {
      const incomeExpenseData = { income: 0, expense: 0 };
      const monthlyData = {};
      const categoryData = {};

      allTransactions.forEach(t => {
        if (t.type === 'income') incomeExpenseData.income += t.amount;
        else incomeExpenseData.expense += t.amount;
        
        const date = t.date.toDate ? t.date.toDate() : new Date(t.date);
        const monthYear = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        if (!monthlyData[monthYear]) monthlyData[monthYear] = { income: 0, expense: 0 };
        if (t.type === 'income') monthlyData[monthYear].income += t.amount;
        else monthlyData[monthYear].expense += t.amount;

        if (!categoryData[t.category]) categoryData[t.category] = 0;
        categoryData[t.category] += t.amount;
      });

      // ============ FORECAST (Advanced Financial Forecasting) ============
      const months = Object.keys(monthlyData).slice(-3);
      const avgIncome = months.length > 0 ? months.reduce((sum, m) => sum + monthlyData[m].income, 0) / months.length : 0;
      const avgExpense = months.length > 0 ? months.reduce((sum, m) => sum + monthlyData[m].expense, 0) / months.length : 0;
      const monthlyForecast = {};
      for (let i = 1; i <= 3; i++) {
        monthlyForecast[`+${i}M`] = { 
          income: Math.round(avgIncome * (1 + (Math.random() - 0.5) * 0.2)), 
          expense: Math.round(avgExpense * (1 + (Math.random() - 0.5) * 0.2)) 
        };
      }

      // Chart 1: Overview
      const ctx1 = document.getElementById('overviewChart');
      if (overviewChart) overviewChart.destroy();
      overviewChart = new Chart(ctx1, {
        type: 'doughnut',
        data: {
          labels: ['Income', 'Expense'],
          datasets: [{
            data: [incomeExpenseData.income, incomeExpenseData.expense],
            backgroundColor: ['#10b981', '#ef4444'],
            borderRadius: 6,
          }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });

      // Chart 2: Trend
      const monthLabels = Object.keys(monthlyData);
      const ctx2 = document.getElementById('trendChart');
      if (trendChart) trendChart.destroy();
      trendChart = new Chart(ctx2, {
        type: 'line',
        data: {
          labels: monthLabels,
          datasets: [
            { label: 'Income', data: monthLabels.map(m => monthlyData[m].income), borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', tension: 0.4, borderWidth: 2 },
            { label: 'Expense', data: monthLabels.map(m => monthlyData[m].expense), borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', tension: 0.4, borderWidth: 2 }
          ]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });

      // Chart 3: Forecast
      const forecastLabels = Object.keys(monthlyForecast);
      const ctx3 = document.getElementById('forecastChart');
      if (forecastChart) forecastChart.destroy();
      forecastChart = new Chart(ctx3, {
        type: 'bar',
        data: {
          labels: forecastLabels,
          datasets: [
            { label: 'Predicted Income', data: forecastLabels.map(m => monthlyForecast[m].income), backgroundColor: '#10b981' },
            { label: 'Predicted Expense', data: forecastLabels.map(m => monthlyForecast[m].expense), backgroundColor: '#ef4444' }
          ]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });
    }

    // ============ CLIENT MANAGEMENT ============
    async function addClient() {
      const name = document.getElementById('clientName').value;
      const email = document.getElementById('clientEmail').value;
      const phone = document.getElementById('clientPhone').value;
      const address = document.getElementById('clientAddress').value;
      const msg = document.getElementById('clientMessage');

      if (!name) { msg.textContent = '‚ùå Enter client name'; msg.classList.add('error'); return; }

      try {
        await db.collection('users').doc(currentUser.uid)
          .collection('businesses').doc(currentBusiness.id)
          .collection('clients').add({
            name, email, phone, address, createdAt: new Date()
          });
        msg.textContent = '‚úÖ Client added!';
        msg.classList.add('success');
        document.getElementById('clientName').value = '';
        document.getElementById('clientEmail').value = '';
        document.getElementById('clientPhone').value = '';
        document.getElementById('clientAddress').value = '';
        setTimeout(() => { msg.textContent = ''; loadClients(); }, 1500);
      } catch (error) {
        msg.textContent = '‚ùå Error: ' + error.message;
        msg.classList.add('error');
      }
    }

    function displayClients() {
      let html = '';
      allClients.forEach(c => {
        html += `
          <div class="table-row">
            <div><strong>${c.name}</strong></div>
            <div>${c.email || '-'}</div>
            <div>${c.phone || '-'}</div>
            <div>${c.address || '-'}</div>
            <div><button class="small-btn" onclick="deleteClient('${c.id}')">Delete</button></div>
          </div>
        `;
      });
      document.getElementById('clientsList').innerHTML = html || '<div class="table-row">No clients yet</div>';
    }

    async function deleteClient(id) {
      if (!confirm('Delete this client?')) return;
      try {
        await db.collection('users').doc(currentUser.uid)
          .collection('businesses').doc(currentBusiness.id)
          .collection('clients').doc(id).delete();
        loadClients();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    function populateClientSelector() {
      const selector = document.getElementById('invoiceClient');
      selector.innerHTML = '<option value="">Select Client</option>';
      allClients.forEach(c => {
        selector.innerHTML += `<option value="${c.id}">${c.name}</option>`;
      });
    }

    function populateInvoiceDetails() {
      const clientId = document.getElementById('invoiceClient').value;
      const client = allClients.find(c => c.id === clientId);
      if (client) {
        console.log('Client selected:', client);
      }
    }

    // ============ INVOICE MANAGEMENT ============
    async function createInvoice() {
      const clientId = document.getElementById('invoiceClient').value;
      const amount = parseFloat(document.getElementById('invoiceAmount').value);
      const description = document.getElementById('invoiceDescription').value;
      const status = document.getElementById('invoiceStatus').value;
      const msg = document.getElementById('invoiceMessage');

      if (!clientId || !amount) { msg.textContent = '‚ùå Fill all fields'; msg.classList.add('error'); return; }

      try {
        const client = allClients.find(c => c.id === clientId);
        const invoiceNum = 'INV-' + new Date().getTime();
        
        await db.collection('users').doc(currentUser.uid)
          .collection('businesses').doc(currentBusiness.id)
          .collection('invoices').add({
            invoiceNumber: invoiceNum,
            clientId,
            clientName: client.name,
            clientEmail: client.email,
            clientPhone: client.phone,
            amount,
            description,
            status,
            date: new Date(),
            createdAt: new Date()
          });
        
        msg.textContent = '‚úÖ Invoice created!';
        msg.classList.add('success');
        document.getElementById('invoiceAmount').value = '';
        document.getElementById('invoiceDescription').value = '';
        setTimeout(() => { msg.textContent = ''; loadInvoices(); updateSummaryCards(); }, 1500);
      } catch (error) {
        msg.textContent = '‚ùå Error: ' + error.message;
        msg.classList.add('error');
      }
    }

    function displayInvoices() {
      let html = '';
      allInvoices.forEach(inv => {
        const date = inv.date.toDate ? inv.date.toDate().toLocaleDateString() : new Date(inv.date).toLocaleDateString();
        html += `
          <div class="table-row">
            <div><strong>${inv.invoiceNumber}</strong></div>
            <div>${inv.clientName}</div>
            <div>‚Çπ${inv.amount.toLocaleString()}</div>
            <div><span style="padding: 4px 8px; border-radius: 4px; background: ${inv.status === 'paid' ? '#10b981' : '#f59e0b'}; color: white; font-size: 12px;">${inv.status.toUpperCase()}</span></div>
            <div>${date}</div>
            <div><button class="small-btn" onclick="downloadInvoice('${inv.id}')">üì• PDF</button></div>
          </div>
        `;
      });
      document.getElementById('invoicesList').innerHTML = html || '<div class="table-row">No invoices yet</div>';
    }

    async function downloadInvoice(id) {
      const invoice = allInvoices.find(inv => inv.id === id);
      if (!invoice) return;

      const element = document.createElement('div');
      element.innerHTML = `
        <div style="padding: 40px; border: 2px solid #667eea; font-family: Arial;">
          <div style="text-align: center; border-bottom: 3px solid #667eea; padding-bottom: 20px; margin-bottom: 30px;">
            <h2 style="margin: 0;">${currentBusiness.name || 'Dream Harbour'}</h2>
            <p style="margin: 5px 0; color: #666;">INVOICE</p>
            <p style="margin: 5px 0; font-size: 18px; font-weight: bold;">${invoice.invoiceNumber}</p>
          </div>
          <p><strong>Bill To:</strong></p>
          <p>${invoice.clientName}<br/>${invoice.clientEmail || ''}<br/>${invoice.clientPhone || ''}</p>
          <table style="width: 100%; border-collapse: collapse; margin: 30px 0;">
            <tr>
              <th style="border: 1px solid #ddd; padding: 10px; background: #f0f0f0; text-align: left;">Description</th>
              <th style="border: 1px solid #ddd; padding: 10px; background: #f0f0f0; text-align: right;">Amount</th>
            </tr>
            <tr>
              <td style="border: 1px solid #ddd; padding: 10px;">${invoice.description}</td>
              <td style="border: 1px solid #ddd; padding: 10px; text-align: right;">‚Çπ${invoice.amount.toLocaleString()}</td>
            </tr>
            <tr>
              <td style="border: 1px solid #ddd; padding: 10px; font-weight: bold;">TOTAL</td>
              <td style="border: 1px solid #ddd; padding: 10px; text-align: right; font-weight: bold; font-size: 18px; color: #10b981;">‚Çπ${invoice.amount.toLocaleString()}</td>
            </tr>
          </table>
          <p style="text-align: center; margin-top: 40px;">
            <span style="padding: 8px 16px; border-radius: 4px; background: ${invoice.status === 'paid' ? '#10b981' : '#f59e0b'}; color: white; font-weight: bold;">
              ${invoice.status.toUpperCase()}
            </span>
          </p>
          <p style="text-align: center; margin-top: 40px; color: #999; font-size: 12px;">Thank you for your business!</p>
        </div>
      `;

      const opt = {
        margin: 10,
        filename: `${invoice.invoiceNumber}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
      };

      html2pdf().set(opt).from(element).save();
    }

    // ============ TRANSACTIONS & TAGS ============
    async function addTransaction() {
      const type = document.getElementById('transactionType').value;
      const amount = parseFloat(document.getElementById('amount').value);
      const category = document.getElementById('category').value;
      const description = document.getElementById('description').value;
      const msg = document.getElementById('transactionMessage');

      if (!amount || !category) { msg.textContent = '‚ùå Fill all fields'; msg.classList.add('error'); return; }

      try {
        await db.collection('users').doc(currentUser.uid)
          .collection('businesses').doc(currentBusiness.id)
          .collection('transactions').add({
            userId: currentUser.uid,
            type,
            amount,
            category,
            description,
            tags: [],
            date: new Date(),
            userPhone: currentUser.phoneNumber
          });

        msg.textContent = '‚úÖ Transaction added!';
        msg.classList.add('success');
        document.getElementById('amount').value = '';
        document.getElementById('category').value = '';
        document.getElementById('description').value = '';
        
        setTimeout(() => { msg.textContent = ''; loadAllData(); }, 1500);
      } catch (error) {
        msg.textContent = '‚ùå Error: ' + error.message;
        msg.classList.add('error');
      }
    }

    function displayTransactions() {
      let html = '';
      allTransactions.forEach(t => {
        const date = t.date.toDate ? t.date.toDate().toLocaleDateString() : new Date(t.date).toLocaleDateString();
        html += `
          <div class="table-row">
            <div><strong>${t.category}</strong></div>
            <div style="color: ${t.type === 'income' ? '#10b981' : '#ef4444'}; font-weight: 700;">
              ${t.type === 'income' ? '+' : '-'} ‚Çπ${t.amount.toLocaleString()}
            </div>
            <div>${t.tags && t.tags.length > 0 ? t.tags.join(', ') : '-'}</div>
            <div>${date}</div>
            <div><button class="small-btn" onclick="deleteTransaction('${t.id}')">üóëÔ∏è Delete</button></div>
          </div>
        `;
      });
      document.getElementById('transactionsList').innerHTML = html || '<div class="table-row">No transactions yet</div>';
    }

    async function deleteTransaction(id) {
      if (!confirm('Delete transaction?')) return;
      try {
        await db.collection('users').doc(currentUser.uid)
          .collection('businesses').doc(currentBusiness.id)
          .collection('transactions').doc(id).delete();
        loadAllData();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    function filterTransactions() {
      const search = document.getElementById('searchBox').value.toLowerCase();
      const month = document.getElementById('filterMonth').value;
      const tag = document.getElementById('filterTag').value;
      
      let filtered = allTransactions.filter(t => {
        const categoryMatch = t.category.toLowerCase().includes(search);
        const date = t.date.toDate ? t.date.toDate() : new Date(t.date);
        const monthMatch = !month || (date.getMonth() + 1).toString().padStart(2, '0') === month;
        const tagMatch = !tag || (t.tags && t.tags.includes(tag));
        return categoryMatch && monthMatch && tagMatch;
      });

      let html = '';
      filtered.forEach(t => {
        const date = t.date.toDate ? t.date.toDate().toLocaleDateString() : new Date(t.date).toLocaleDateString();
        html += `
          <div class="table-row">
            <div><strong>${t.category}</strong></div>
            <div style="color: ${t.type === 'income' ? '#10b981' : '#ef4444'}; font-weight: 700;">
              ${t.type === 'income' ? '+' : '-'} ‚Çπ${t.amount.toLocaleString()}
            </div>
            <div>${t.tags && t.tags.length > 0 ? t.tags.join(', ') : '-'}</div>
            <div>${date}</div>
            <div><button class="small-btn" onclick="deleteTransaction('${t.id}')">üóëÔ∏è Delete</button></div>
          </div>
        `;
      });
      document.getElementById('transactionsList').innerHTML = html || '<div class="table-row">No matching transactions</div>';
    }

    // ============ RECURRING TRANSACTIONS ============
    async function processRecurringTransactions() {
      const today = new Date();
      for (const recurring of recurringTransactions) {
        const lastDate = recurring.lastProcessed ? new Date(recurring.lastProcessed) : new Date(0);
        const daysSince = (today - lastDate) / (1000 * 60 * 60 * 24);

        if (daysSince >= recurring.frequency) {
          await db.collection('users').doc(currentUser.uid)
            .collection('businesses').doc(currentBusiness.id)
            .collection('transactions').add({
              type: recurring.type,
              amount: recurring.amount,
              category: recurring.category,
              description: `[Recurring] ${recurring.description}`,
              tags: ['recurring'],
              date: new Date(),
              recurringId: recurring.id
            });

          await db.collection('users').doc(currentUser.uid)
            .collection('businesses').doc(currentBusiness.id)
            .collection('recurringTransactions').doc(recurring.id)
            .update({ lastProcessed: new Date() });
        }
      }
    }

    // ============ CUSTOM REPORTS ============
    async function generateReport() {
      const startDate = new Date(document.getElementById('reportStartDate').value);
      const endDate = new Date(document.getElementById('reportEndDate').value);
      const reportType = document.getElementById('reportType').value;

      if (!startDate || !endDate) { alert('Select dates'); return; }

      let html = '<div class="form-area"><h3>üìä Report: ' + startDate.toLocaleDateString() + ' to ' + endDate.toLocaleDateString() + '</h3>';

      let income = 0, expense = 0, transactionCount = 0;
      const categoryBreakdown = {};
      
      const filtered = allTransactions.filter(t => {
        const d = t.date.toDate ? t.date.toDate() : new Date(t.date);
        return d >= startDate && d <= endDate;
      });

      filtered.forEach(t => {
        transactionCount++;
        if (t.type === 'income') income += t.amount;
        else expense += t.amount;
        
        if (!categoryBreakdown[t.category]) categoryBreakdown[t.category] = { income: 0, expense: 0 };
        if (t.type === 'income') categoryBreakdown[t.category].income += t.amount;
        else categoryBreakdown[t.category].expense += t.amount;
      });

      html += `<p><strong>Period:</strong> ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}</p>`;
      html += `<p><strong>Total Transactions:</strong> ${transactionCount}</p>`;
      html += `<p><strong>Total Income:</strong> ‚Çπ${income.toLocaleString()}</p>`;
      html += `<p><strong>Total Expense:</strong> ‚Çπ${expense.toLocaleString()}</p>`;
      html += `<p><strong>Net Profit/Loss:</strong> <span style="color: ${income - expense >= 0 ? '#10b981' : '#ef4444'}; font-weight: bold;">‚Çπ${(income - expense).toLocaleString()}</span></p>`;

      if (reportType === 'pl') {
        html += `<p><strong>Profit Margin:</strong> ${income > 0 ? ((income - expense) / income * 100).toFixed(2) : '0'}%</p>`;
      }

      if (reportType === 'detailed') {
        html += '<h4>Category Breakdown</h4>';
        for (const [category, data] of Object.entries(categoryBreakdown)) {
          html += `<p>${category}: Income ‚Çπ${data.income}, Expense ‚Çπ${data.expense}, Net ‚Çπ${data.income - data.expense}</p>`;
        }
        html += '<h4>Transactions</h4>';
        filtered.forEach(t => {
          const date = t.date.toDate ? t.date.toDate().toLocaleDateString() : new Date(t.date).toLocaleDateString();
          html += `<p>${date} - ${t.category}: ${t.type === 'income' ? '+' : '-'} ‚Çπ${t.amount}</p>`;
        });
      }

      html += '</div>';
      document.getElementById('reportContent').innerHTML = html;
    }

    function exportReportPDF() {
      const element = document.getElementById('reportContent');
      if (!element.innerHTML) { alert('Generate report first'); return; }
      const opt = {
        margin: 10,
        filename: 'Dream_Harbour_Report.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
      };
      html2pdf().set(opt).from(element).save();
    }

    // ============ SETTINGS & EXPORT ============
    async function saveBusiness Settings() {
      const name = document.getElementById('businessName').value;
      const email = document.getElementById('businessEmail').value;
      const phone = document.getElementById('businessPhone').value;
      const address = document.getElementById('businessAddress').value;
      const bankDetails = document.getElementById('businessBankDetails').value;
      const msg = document.getElementById('settingsMessage');

      try {
        await db.collection('users').doc(currentUser.uid)
          .collection('businesses').doc(currentBusiness.id)
          .update({
            name, email, phone, address, bankDetails
          });
        
        currentBusiness = { ...currentBusiness, name, email, phone, address, bankDetails };
        msg.textContent = '‚úÖ Settings saved!';
        msg.classList.add('success');
        setTimeout(() => { msg.textContent = ''; }, 2000);
      } catch (error) {
        msg.textContent = '‚ùå Error: ' + error.message;
        msg.classList.add('error');
      }
    }

    function exportToCSV() {
      let csv = 'Category,Amount,Type,Tags,Date,Description\n';
      allTransactions.forEach(t => {
        const date = t.date.toDate ? t.date.toDate().toLocaleDateString() : new Date(t.date).toLocaleDateString();
        csv += `"${t.category}","${t.amount}","${t.type}","${(t.tags || []).join(';')}","${date}","${t.description || ''}"\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Dream_Harbour_${currentBusiness.name || 'Data'}_${new Date().toLocaleDateString()}.csv`;
      a.click();
      document.getElementById('exportMessage').textContent = '‚úÖ CSV exported!';
      document.getElementById('exportMessage').classList.add('success');
      setTimeout(() => { document.getElementById('exportMessage').textContent = ''; }, 2000);
    }

    function exportToJSON() {
      const data = {
        business: currentBusiness,
        transactions: allTransactions,
        clients: allClients,
        invoices: allInvoices,
        exportDate: new Date()
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Dream_Harbour_${currentBusiness.name || 'Data'}_${new Date().toLocaleDateString()}.json`;
      a.click();
      document.getElementById('exportMessage').textContent = '‚úÖ JSON exported!';
      document.getElementById('exportMessage').classList.add('success');
      setTimeout(() => { document.getElementById('exportMessage').textContent = ''; }, 2000);
    }

    function printReport() {
      window.print();
    }

    function clearAllData() {
      if (!confirm('‚ö†Ô∏è PERMANENTLY DELETE ALL DATA? This cannot be undone!')) return;
      if (!confirm('Are you absolutely sure? Type "DELETE" to confirm.')) return;
      alert('Feature requires manual confirmation. Contact support.');
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    }

    function logout() {
      auth.signOut();
    }

    // ============ INITIALIZATION ============
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark-mode');
    }
</body>
</html>
