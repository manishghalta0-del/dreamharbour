<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dream Harbour - Enterprise</title>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; }
    .header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; text-align: center; }
    .header h1 { font-size: 32px; margin-bottom: 4px; }
    .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
    .login-box { background: white; border-radius: 12px; padding: 40px; max-width: 450px; margin: 60px auto; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    input, select { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; margin: 12px 0; font-size: 16px; }
    input:focus { outline: none; border-color: #667eea; }
    button { width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin: 12px 0; }
    button:hover { transform: translateY(-2px); }
    .error { color: #ef4444; margin: 10px 0; }
    .success { color: #10b981; margin: 10px 0; }
    .hidden { display: none !important; }
    .dashboard { display: none; }
    .dashboard.active { display: block; }
    .card { background: white; padding: 20px; border-radius: 8px; margin: 15px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .card h3 { color: #667eea; font-size: 14px; margin-bottom: 10px; }
    .card .amount { font-size: 28px; font-weight: bold; color: #333; }
    .top-bar { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .badge { display: inline-block; padding: 4px 12px; background: #667eea; color: white; border-radius: 20px; font-size: 12px; }
    .logout-btn { background: #ef4444; width: auto; padding: 10px 20px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; }
    .tab-btn { padding: 10px 20px; background: none; border: none; color: #666; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; }
    .tab-btn.active { color: #667eea; border-bottom-color: #667eea; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .table-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; padding: 15px; border-bottom: 1px solid #e5e7eb; }
    .table-header { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; padding: 15px; background: #f9fafb; font-weight: 600; color: #666; font-size: 12px; }
    .small-btn { width: auto; padding: 8px 16px; font-size: 13px; }
  </style>
</head>
<body>
  <div class="header">
    <h1>ðŸ’¼ Dream Harbour Enterprise</h1>
    <p>Business Accounting & Invoice Management</p>
  </div>

  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="login-box">
    <h2>Welcome</h2>
    <div id="loginSection">
      <input type="tel" id="phoneNumber" placeholder="+919999999999">
      <div id="recaptcha-container"></div>
      <button onclick="sendOTP()">Send OTP</button>
      <div id="sendError" class="error"></div>
    </div>
    <div id="otpSection" class="hidden">
      <input type="text" id="otpCode" placeholder="Enter 6-digit OTP" maxlength="6">
      <button onclick="verifyOTP()">Verify Login</button>
      <div id="verifyError" class="error"></div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboardScreen" class="dashboard">
    <div class="container">
      <div class="top-bar">
        <div>
          <p><strong id="userPhone"></strong></p>
          <span class="badge" id="roleBadge">OWNER</span>
        </div>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>

      <div class="grid">
        <div class="card"><h3>ðŸ’° Total Income</h3><div class="amount" id="totalIncome">â‚¹0</div></div>
        <div class="card"><h3>ðŸ’¸ Total Expense</h3><div class="amount" id="totalExpense">â‚¹0</div></div>
        <div class="card"><h3>ðŸ“Š Balance</h3><div class="amount" id="netBalance">â‚¹0</div></div>
      </div>

      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('transactions')">Transactions</button>
        <button class="tab-btn" onclick="switchTab('addTx')">Add Transaction</button>
      </div>

      <div id="transactions" class="card tab-content active">
        <h3>All Transactions</h3>
        <div class="table-header">
          <div>Category</div>
          <div>Amount</div>
          <div>Type</div>
          <div>Date</div>
        </div>
        <div id="txList"></div>
      </div>

      <div id="addTx" class="card tab-content hidden">
        <h3>Add Transaction</h3>
        <select id="txType">
          <option value="income">Income</option>
          <option value="expense">Expense</option>
        </select>
        <input type="number" id="txAmount" placeholder="Amount">
        <input type="text" id="txCategory" placeholder="Category">
        <input type="text" id="txDesc" placeholder="Description">
        <button onclick="addTransaction()">Add</button>
        <div id="txMsg"></div>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC-tQWS8o_Y7ZJtI3JjW9Uk4I9aHJ1ZDxs",
      authDomain: "dream-harbour.firebaseapp.com",
      projectId: "dream-harbour",
      storageBucket: "dream-harbour.firebasestorage.app",
      messagingSenderId: "857245144265",
      appId: "1:857245144265:web:6855412224da516592e918"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

    let confirmationResult, currentUser = null;
    let transactions = [];

    function sendOTP() {
      const phone = document.getElementById('phoneNumber').value;
      if (!phone) { alert('Enter phone'); return; }
      const appVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { size: 'invisible' });
      auth.signInWithPhoneNumber(phone, appVerifier)
        .then(r => {
          confirmationResult = r;
          document.getElementById('loginSection').classList.add('hidden');
          document.getElementById('otpSection').classList.remove('hidden');
        })
        .catch(e => alert('Error: ' + e.message));
    }

    function verifyOTP() {
      const otp = document.getElementById('otpCode').value;
      if (otp.length !== 6) { alert('Enter 6-digit OTP'); return; }
      confirmationResult.confirm(otp)
        .then(r => { currentUser = r.user; showDashboard(); })
        .catch(e => alert('Invalid OTP'));
    }

    auth.onAuthStateChanged(user => {
      if (user && currentUser) showDashboard();
      else showLogin();
    });

    function showDashboard() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('dashboardScreen').classList.add('active');
      document.getElementById('userPhone').textContent = currentUser.phoneNumber;
      loadData();
    }

    function showLogin() {
      document.getElementById('dashboardScreen').classList.remove('active');
      document.getElementById('loginScreen').classList.remove('hidden');
    }

    async function loadData() {
      try {
        const snap = await db.collection('users').doc(currentUser.uid).collection('transactions').orderBy('date', 'desc').get();
        transactions = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        updateCards();
        displayTransactions();
      } catch (e) {
        console.error(e);
        transactions = [];
      }
    }

    function updateCards() {
      let income = 0, expense = 0;
      transactions.forEach(t => {
        if (t.type === 'income') income += t.amount;
        else expense += t.amount;
      });
      document.getElementById('totalIncome').textContent = 'â‚¹' + income;
      document.getElementById('totalExpense').textContent = 'â‚¹' + expense;
      document.getElementById('netBalance').textContent = 'â‚¹' + (income - expense);
    }

    function displayTransactions() {
      let html = '';
      transactions.forEach(t => {
        const date = t.date.toDate ? t.date.toDate().toLocaleDateString() : new Date(t.date).toLocaleDateString();
        html += `<div class="table-row"><div>${t.category}</div><div>â‚¹${t.amount}</div><div>${t.type}</div><div>${date}</div></div>`;
      });
      document.getElementById('txList').innerHTML = html || '<div class="table-row">No transactions</div>';
    }

    async function addTransaction() {
      const type = document.getElementById('txType').value;
      const amount = parseFloat(document.getElementById('txAmount').value);
      const category = document.getElementById('txCategory').value;
      const desc = document.getElementById('txDesc').value;
      const msg = document.getElementById('txMsg');

      if (!amount || !category) { msg.textContent = 'âŒ Fill all fields'; msg.className = 'error'; return; }

      try {
        await db.collection('users').doc(currentUser.uid).collection('transactions').add({
          type, amount, category, description: desc, date: new Date()
        });
        msg.textContent = 'âœ… Added!';
        msg.className = 'success';
        document.getElementById('txAmount').value = '';
        document.getElementById('txCategory').value = '';
        document.getElementById('txDesc').value = '';
        setTimeout(() => { msg.textContent = ''; loadData(); }, 1500);
      } catch (error) {
        msg.textContent = 'âŒ Error: ' + error.message;
        msg.className = 'error';
      }
    }

    function switchTab(name) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(name).classList.add('active');
      event.target.classList.add('active');
    }

    function logout() {
      auth.signOut();
    }
  </script>
</body>
</html>
