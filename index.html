<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Multi-Service Business Suite - CSC, E-Stamping, Document Writing</title>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; }
    .header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; text-align: center; }
    .header h1 { font-size: 32px; margin-bottom: 4px; }
    .header p { font-size: 14px; opacity: 0.9; }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    .login-box { background: white; border-radius: 12px; padding: 40px; max-width: 450px; margin: 60px auto; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    input, select, textarea { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; margin: 12px 0; font-size: 16px; font-family: inherit; }
    input:focus, select:focus { outline: none; border-color: #667eea; }
    button { width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin: 12px 0; }
    button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102,126,234,0.4); }
    .error { color: #ef4444; margin: 10px 0; font-size: 14px; }
    .success { color: #10b981; margin: 10px 0; font-size: 14px; }
    .hidden { display: none !important; }
    .dashboard { display: none; }
    .dashboard.active { display: block; }
    .card { background: white; padding: 20px; border-radius: 8px; margin: 15px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .card h3 { color: #667eea; font-size: 14px; margin-bottom: 10px; font-weight: 600; }
    .card .amount { font-size: 28px; font-weight: bold; color: #333; }
    .top-bar { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); flex-wrap: wrap; gap: 16px; }
    .badge { display: inline-block; padding: 8px 16px; background: #667eea; color: white; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .logout-btn { background: #ef4444; width: auto; padding: 10px 20px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; overflow-x: auto; padding-bottom: 12px; }
    .tab-btn { padding: 10px 20px; background: none; border: none; color: #666; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; white-space: nowrap; }
    .tab-btn.active { color: #667eea; border-bottom-color: #667eea; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .table-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; padding: 15px; border-bottom: 1px solid #e5e7eb; align-items: center; }
    .table-header { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; padding: 15px; background: #f9fafb; font-weight: 600; color: #666; font-size: 12px; }
    .small-btn { width: auto; padding: 8px 16px; font-size: 13px; margin: 4px; }
    .chart-container { background: white; border-radius: 8px; padding: 20px; margin: 15px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .tax-summary { background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea; margin: 15px 0; }
    .tax-summary p { margin: 8px 0; font-size: 14px; }
    .tax-summary .bold { font-weight: 600; color: #667eea; }
  </style>
</head>
<body>
  <div class="header">
    <h1>üè¢ Multi-Service Business Suite</h1>
    <p>CSC | E-Stamping | Document Writing - Complete Accounting & Invoicing</p>
  </div>

  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="login-box">
    <h2>Welcome</h2>
    <div id="loginSection">
      <input type="tel" id="phoneNumber" placeholder="+919999999999">
      <div id="recaptcha-container"></div>
      <button onclick="sendOTP()">Send OTP</button>
      <div id="sendError" class="error"></div>
    </div>
    <div id="otpSection" class="hidden">
      <input type="text" id="otpCode" placeholder="Enter 6-digit OTP" maxlength="6">
      <button onclick="verifyOTP()">Verify Login</button>
      <div id="verifyError" class="error"></div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboardScreen" class="dashboard">
    <div class="container">
      <div class="top-bar">
        <div>
          <p><strong id="userPhone"></strong></p>
          <span class="badge" id="gstinBadge">GSTIN Setup Required</span>
        </div>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>

      <!-- Business Settings (Collapsible) -->
      <div class="card">
        <h3 onclick="toggleBusinessSettings()">‚öôÔ∏è Business Settings & GSTIN</h3>
        <div id="businessSettings" style="display:none; margin-top: 15px;">
          <input type="text" id="businessName" placeholder="Business Name" value="">
          <input type="text" id="gstin" placeholder="GSTIN (15 digits)" value="">
          <input type="email" id="businessEmail" placeholder="Business Email" value="">
          <input type="tel" id="businessPhone" placeholder="Business Phone" value="">
          <input type="text" id="businessAddress" placeholder="Business Address" value="">
          <input type="number" id="gstRate" placeholder="GST Rate (%)" value="18">
          <button onclick="saveBusinessSettings()" class="small-btn">Save Settings</button>
          <div id="settingsMsg"></div>
        </div>
      </div>

      <!-- Summary Cards -->
      <div class="grid">
        <div class="card"><h3>üí∞ Total Revenue</h3><div class="amount" id="totalRevenue">‚Çπ0</div></div>
        <div class="card"><h3>üè¶ Total GST Collected</h3><div class="amount" id="totalGST">‚Çπ0</div></div>
        <div class="card"><h3>üìä Net Income</h3><div class="amount" id="netIncome">‚Çπ0</div></div>
        <div class="card"><h3>üë• Customers</h3><div class="amount" id="totalCustomers">0</div></div>
      </div>

      <!-- Main Tabs -->
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('dashboard')">üìä Dashboard</button>
        <button class="tab-btn" onclick="switchTab('services')">üõ†Ô∏è Services</button>
        <button class="tab-btn" onclick="switchTab('invoices')">üìÑ Invoices</button>
        <button class="tab-btn" onclick="switchTab('customers')">üë• Customers</button>
        <button class="tab-btn" onclick="switchTab('reports')">üìã Reports & Tax</button>
      </div>

      <!-- Dashboard Tab -->
      <div id="dashboard" class="tab-content active">
        <div class="chart-container"><h3>Revenue by Service Type</h3><canvas id="chartServices"></canvas></div>
        <div class="chart-container"><h3>Monthly Revenue Trend</h3><canvas id="chartMonthly"></canvas></div>
      </div>

      <!-- Services Tab -->
      <div id="services" class="tab-content">
        <div class="card">
          <h3>Add Service Entry</h3>
          <select id="serviceType">
            <option value="">Select Service</option>
            <option value="csc">CSC Service</option>
            <option value="estamping">E-Stamping</option>
            <option value="document">Document Writing (Tehsil)</option>
          </select>
          <input type="text" id="sacCode" placeholder="SAC Code (e.g., 998312)">
          <input type="text" id="serviceDesc" placeholder="Service Description">
          <input type="number" id="serviceAmount" placeholder="Amount (Before GST)">
          <select id="customerSelect"><option value="">Select/Add Customer</option></select>
          <button onclick="addService()" class="small-btn">Add Service</button>
          <div id="serviceMsg"></div>
        </div>

        <div class="card">
          <h3>Services List</h3>
          <div class="table-header"><div>Date</div><div>Type</div><div>Description</div><div>Amount</div><div>GST</div><div>Total</div><div>Action</div></div>
          <div id="servicesList"></div>
        </div>
      </div>

      <!-- Invoices Tab -->
      <div id="invoices" class="tab-content">
        <div class="card">
          <h3>Generate Invoice</h3>
          <select id="invoiceServices" multiple size="5">
            <option value="">Select services to invoice...</option>
          </select>
          <input type="date" id="invoiceDate">
          <button onclick="generateInvoice()" class="small-btn">Generate GST Invoice</button>
          <div id="invoiceMsg"></div>
        </div>

        <div class="card">
          <h3>All Invoices</h3>
          <div class="table-header"><div>Invoice #</div><div>Customer</div><div>Amount</div><div>GST</div><div>Total</div><div>Date</div><div>Action</div></div>
          <div id="invoicesList"></div>
        </div>
      </div>

      <!-- Customers Tab -->
      <div id="customers" class="tab-content">
        <div class="card">
          <h3>Add Customer</h3>
          <input type="text" id="custName" placeholder="Customer Name">
          <input type="email" id="custEmail" placeholder="Email">
          <input type="tel" id="custPhone" placeholder="Phone">
          <input type="text" id="custAddress" placeholder="Address">
          <input type="text" id="custGSTIN" placeholder="Customer GSTIN (Optional)">
          <button onclick="addCustomer()" class="small-btn">Add Customer</button>
          <div id="custMsg"></div>
        </div>

        <div class="card">
          <h3>Customers</h3>
          <div class="table-header"><div>Name</div><div>Email</div><div>Phone</div><div>GSTIN</div><div>Action</div></div>
          <div id="customersList"></div>
        </div>
      </div>

      <!-- Reports & Tax Tab -->
      <div id="reports" class="tab-content">
        <div class="card">
          <h3>GST Report Generator</h3>
          <input type="date" id="reportStart">
          <input type="date" id="reportEnd">
          <button onclick="generateGSTReport()" class="small-btn">Generate GST Report</button>
          <button onclick="generateITCReport()" class="small-btn">Generate ITC Report</button>
          <button onclick="exportTaxCSV()" class="small-btn">üìä Export Tax Data CSV</button>
          <div id="reportMsg"></div>
        </div>

        <div class="card" id="taxReportContent"></div>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC-tQWS8o_Y7ZJtI3JjW9Uk4I9aHJ1ZDxs",
      authDomain: "dream-harbour.firebaseapp.com",
      projectId: "dream-harbour",
      storageBucket: "dream-harbour.firebasestorage.app",
      messagingSenderId: "857245144265",
      appId: "1:857245144265:web:6855412224da516592e918"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

    let confirmationResult, currentUser = null;
    let services = [], customers = [], invoices = [];
    let businessSettings = {};
    let chartServices, chartMonthly;

    const SAC_CODES = {
      'csc': '998312',
      'estamping': '998361',
      'document': '998399'
    };

    const SERVICE_NAMES = {
      'csc': 'CSC Service',
      'estamping': 'E-Stamping',
      'document': 'Document Writing'
    };

    function sendOTP() {
      const phone = document.getElementById('phoneNumber').value;
      if (!phone) { alert('Enter phone'); return; }
      const appVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { size: 'invisible' });
      auth.signInWithPhoneNumber(phone, appVerifier)
        .then(r => {
          confirmationResult = r;
          document.getElementById('loginSection').classList.add('hidden');
          document.getElementById('otpSection').classList.remove('hidden');
        })
        .catch(e => alert('Error: ' + e.message));
    }

    function verifyOTP() {
      const otp = document.getElementById('otpCode').value;
      if (otp.length !== 6) { alert('Enter 6-digit OTP'); return; }
      confirmationResult.confirm(otp)
        .then(r => { currentUser = r.user; showDashboard(); })
        .catch(e => alert('Invalid OTP'));
    }

    auth.onAuthStateChanged(user => {
      if (user && currentUser) showDashboard();
      else showLogin();
    });

    function showDashboard() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('dashboardScreen').classList.add('active');
      document.getElementById('userPhone').textContent = currentUser.phoneNumber;
      loadAllData();
    }

    function showLogin() {
      document.getElementById('dashboardScreen').classList.remove('active');
      document.getElementById('loginScreen').classList.remove('hidden');
    }

    async function loadAllData() {
      await loadBusinessSettings();
      await loadServices();
      await loadCustomers();
      await loadInvoices();
      updateCards();
      displayServices();
      displayCustomers();
      displayInvoices();
      updateCharts();
    }

    async function loadBusinessSettings() {
      try {
        const doc = await db.collection('users').doc(currentUser.uid).collection('settings').doc('business').get();
        if (doc.exists) {
          businessSettings = doc.data();
          document.getElementById('businessName').value = businessSettings.name || '';
          document.getElementById('gstin').value = businessSettings.gstin || '';
          document.getElementById('businessEmail').value = businessSettings.email || '';
          document.getElementById('businessPhone').value = businessSettings.phone || '';
          document.getElementById('businessAddress').value = businessSettings.address || '';
          document.getElementById('gstRate').value = businessSettings.gstRate || '18';
          if (businessSettings.gstin) {
            document.getElementById('gstinBadge').textContent = 'GSTIN: ' + businessSettings.gstin;
            document.getElementById('gstinBadge').style.background = '#10b981';
          }
        }
      } catch (e) { console.error(e); }
    }

    async function saveBusinessSettings() {
      const settings = {
        name: document.getElementById('businessName').value,
        gstin: document.getElementById('gstin').value,
        email: document.getElementById('businessEmail').value,
        phone: document.getElementById('businessPhone').value,
        address: document.getElementById('businessAddress').value,
        gstRate: parseFloat(document.getElementById('gstRate').value) || 18
      };
      try {
        await db.collection('users').doc(currentUser.uid).collection('settings').doc('business').set(settings);
        businessSettings = settings;
        document.getElementById('settingsMsg').textContent = '‚úÖ Settings Saved!';
        document.getElementById('settingsMsg').className = 'success';
        setTimeout(() => { document.getElementById('settingsMsg').textContent = ''; loadAllData(); }, 2000);
      } catch (e) {
        document.getElementById('settingsMsg').textContent = '‚ùå Error: ' + e.message;
        document.getElementById('settingsMsg').className = 'error';
      }
    }

    function toggleBusinessSettings() {
      const elem = document.getElementById('businessSettings');
      elem.style.display = elem.style.display === 'none' ? 'block' : 'none';
    }

    async function loadServices() {
      try {
        const snap = await db.collection('users').doc(currentUser.uid).collection('services').orderBy('date', 'desc').get();
        services = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch (e) { services = []; }
    }

    async function loadCustomers() {
      try {
        const snap = await db.collection('users').doc(currentUser.uid).collection('customers').get();
        customers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        populateCustomerSelect();
      } catch (e) { customers = []; }
    }

    async function loadInvoices() {
      try {
        const snap = await db.collection('users').doc(currentUser.uid).collection('invoices').orderBy('date', 'desc').get();
        invoices = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch (e) { invoices = []; }
    }

    async function addCustomer() {
      const name = document.getElementById('custName').value;
      const email = document.getElementById('custEmail').value;
      const phone = document.getElementById('custPhone').value;
      const address = document.getElementById('custAddress').value;
      const gstin = document.getElementById('custGSTIN').value;
      if (!name) { alert('Enter customer name'); return; }
      try {
        await db.collection('users').doc(currentUser.uid).collection('customers').add({
          name, email, phone, address, gstin, createdAt: new Date()
        });
        document.getElementById('custName').value = '';
        document.getElementById('custEmail').value = '';
        document.getElementById('custPhone').value = '';
        document.getElementById('custAddress').value = '';
        document.getElementById('custGSTIN').value = '';
        loadAllData();
      } catch (e) { alert('Error: ' + e.message); }
    }

    function populateCustomerSelect() {
      const sel = document.getElementById('customerSelect');
      sel.innerHTML = '<option value="">Select Customer</option>';
      customers.forEach(c => {
        sel.innerHTML += `<option value="${c.id}">${c.name}</option>`;
      });
    }

    function displayCustomers() {
      let html = '';
      customers.forEach(c => {
        html += `<div class="table-row"><div>${c.name}</div><div>${c.email || '-'}</div><div>${c.phone || '-'}</div><div>${c.gstin || '-'}</div><div><button class="small-btn" onclick="deleteCustomer('${c.id}')">Delete</button></div></div>`;
      });
      document.getElementById('customersList').innerHTML = html || '<div class="table-row">No customers</div>';
    }

    async function deleteCustomer(id) {
      if (!confirm('Delete customer?')) return;
      try {
        await db.collection('users').doc(currentUser.uid).collection('customers').doc(id).delete();
        loadAllData();
      } catch (e) { alert('Error: ' + e.message); }
    }

    async function addService() {
      const serviceType = document.getElementById('serviceType').value;
      const serviceDesc = document.getElementById('serviceDesc').value;
      const amount = parseFloat(document.getElementById('serviceAmount').value);
      const customerId = document.getElementById('customerSelect').value;
      if (!serviceType || !amount || !customerId) { alert('Fill all fields'); return; }

      const gstRate = businessSettings.gstRate || 18;
      const gstAmount = (amount * gstRate) / 100;
      const totalAmount = amount + gstAmount;

      try {
        await db.collection('users').doc(currentUser.uid).collection('services').add({
          serviceType,
          description: serviceDesc,
          sacCode: SAC_CODES[serviceType],
          amount,
          gstRate,
          gstAmount,
          totalAmount,
          customerId,
          date: new Date()
        });
        document.getElementById('serviceDesc').value = '';
        document.getElementById('serviceAmount').value = '';
        loadAllData();
      } catch (e) { alert('Error: ' + e.message); }
    }

    function displayServices() {
      let html = '';
      services.forEach(s => {
        const date = s.date.toDate ? s.date.toDate().toLocaleDateString() : new Date(s.date).toLocaleDateString();
        html += `<div class="table-row"><div>${date}</div><div>${SERVICE_NAMES[s.serviceType]}</div><div>${s.description}</div><div>‚Çπ${s.amount}</div><div>‚Çπ${s.gstAmount.toFixed(2)}</div><div>‚Çπ${s.totalAmount.toFixed(2)}</div><div><button class="small-btn" onclick="deleteService('${s.id}')">Delete</button></div></div>`;
      });
      document.getElementById('servicesList').innerHTML = html || '<div class="table-row">No services</div>';
    }

    async function deleteService(id) {
      if (!confirm('Delete service?')) return;
      try {
        await db.collection('users').doc(currentUser.uid).collection('services').doc(id).delete();
        loadAllData();
      } catch (e) { alert('Error: ' + e.message); }
    }

    async function generateInvoice() {
      const selectedIndices = Array.from(document.getElementById('invoiceServices').selectedOptions).map(opt => opt.value);
      if (selectedIndices.length === 0) { alert('Select services'); return; }

      const selectedServices = services.filter(s => selectedIndices.includes(s.id));
      let totalAmount = 0, totalGST = 0;
      selectedServices.forEach(s => {
        totalAmount += s.amount;
        totalGST += s.gstAmount;
      });

      const invoiceNum = 'INV-' + Date.now();
      const invoice = {
        invoiceNumber: invoiceNum,
        services: selectedServices,
        subtotal: totalAmount,
        gst: totalGST,
        total: totalAmount + totalGST,
        date: new Date()
      };

      try {
        await db.collection('users').doc(currentUser.uid).collection('invoices').add(invoice);
        downloadGSTInvoice(invoice);
        loadAllData();
      } catch (e) { alert('Error: ' + e.message); }
    }

    function downloadGSTInvoice(invoice) {
      let html = `<div style="padding: 40px; font-family: Arial;">
        <h2 style="text-align: center; border-bottom: 2px solid #667eea; padding-bottom: 20px;">GST INVOICE</h2>
        <p style="text-align: center;"><strong>${businessSettings.name}</strong></p>
        <p style="text-align: center;">GSTIN: ${businessSettings.gstin}</p>
        <p style="text-align: center;">${businessSettings.address}</p>
        <p style="text-align: center; margin-top: 20px;"><strong>Invoice #: ${invoice.invoiceNumber}</strong></p>
        <p style="text-align: center;">Date: ${new Date(invoice.date).toLocaleDateString()}</p>
        
        <table style="width: 100%; border-collapse: collapse; margin: 30px 0;">
          <tr style="background: #f0f0f0;">
            <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">Description</th>
            <th style="border: 1px solid #ddd; padding: 10px;">SAC Code</th>
            <th style="border: 1px solid #ddd; padding: 10px; text-align: right;">Amount</th>
            <th style="border: 1px solid #ddd; padding: 10px; text-align: right;">GST ${businessSettings.gstRate}%</th>
            <th style="border: 1px solid #ddd; padding: 10px; text-align: right;">Total</th>
          </tr>`;
      
      invoice.services.forEach(s => {
        html += `<tr>
          <td style="border: 1px solid #ddd; padding: 10px;">${s.description}</td>
          <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${s.sacCode}</td>
          <td style="border: 1px solid #ddd; padding: 10px; text-align: right;">‚Çπ${s.amount.toFixed(2)}</td>
          <td style="border: 1px solid #ddd; padding: 10px; text-align: right;">‚Çπ${s.gstAmount.toFixed(2)}</td>
          <td style="border: 1px solid #ddd; padding: 10px; text-align: right;">‚Çπ${s.totalAmount.toFixed(2)}</td>
        </tr>`;
      });

      html += `</table>
        <div style="text-align: right; margin-top: 20px;">
          <p><strong>Subtotal: ‚Çπ${invoice.subtotal.toFixed(2)}</strong></p>
          <p><strong>GST: ‚Çπ${invoice.gst.toFixed(2)}</strong></p>
          <p style="font-size: 18px; color: #667eea;"><strong>TOTAL: ‚Çπ${invoice.total.toFixed(2)}</strong></p>
        </div>
      </div>`;

      const opt = { margin: 10, filename: invoice.invoiceNumber + '.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { format: 'a4' } };
      html2pdf().set(opt).from(html).save();
    }

    function displayInvoices() {
      let html = '';
      invoices.forEach(inv => {
        const date = inv.date.toDate ? inv.date.toDate().toLocaleDateString() : new Date(inv.date).toLocaleDateString();
        html += `<div class="table-row"><div>${inv.invoiceNumber}</div><div>${inv.services.length} items</div><div>‚Çπ${inv.subtotal.toFixed(2)}</div><div>‚Çπ${inv.gst.toFixed(2)}</div><div>‚Çπ${inv.total.toFixed(2)}</div><div>${date}</div><div><button class="small-btn" onclick="redownloadInvoice('${inv.invoiceNumber}')">PDF</button></div></div>`;
      });
      document.getElementById('invoicesList').innerHTML = html || '<div class="table-row">No invoices</div>';
    }

    function redownloadInvoice(invNum) {
      const inv = invoices.find(i => i.invoiceNumber === invNum);
      if (inv) downloadGSTInvoice(inv);
    }

    function updateCards() {
      let totalRevenue = 0, totalGST = 0;
      services.forEach(s => {
        totalRevenue += s.amount;
        totalGST += s.gstAmount;
      });
      document.getElementById('totalRevenue').textContent = '‚Çπ' + totalRevenue.toLocaleString();
      document.getElementById('totalGST').textContent = '‚Çπ' + totalGST.toFixed(2);
      document.getElementById('netIncome').textContent = '‚Çπ' + (totalRevenue).toLocaleString();
      document.getElementById('totalCustomers').textContent = customers.length;
    }

    function updateCharts() {
      const serviceData = { csc: 0, estamping: 0, document: 0 };
      services.forEach(s => {
        serviceData[s.serviceType] += s.amount;
      });

      if (chartServices) chartServices.destroy();
      const ctx1 = document.getElementById('chartServices');
      chartServices = new Chart(ctx1, {
        type: 'pie',
        data: {
          labels: ['CSC', 'E-Stamping', 'Document Writing'],
          datasets: [{ data: [serviceData.csc, serviceData.estamping, serviceData.document], backgroundColor: ['#667eea', '#764ba2', '#f59e0b'], borderRadius: 6 }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });

      const monthlyData = {};
      services.forEach(s => {
        const date = s.date.toDate ? s.date.toDate() : new Date(s.date);
        const monthYear = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        if (!monthlyData[monthYear]) monthlyData[monthYear] = 0;
        monthlyData[monthYear] += s.amount;
      });

      const monthLabels = Object.keys(monthlyData);
      if (chartMonthly) chartMonthly.destroy();
      const ctx2 = document.getElementById('chartMonthly');
      chartMonthly = new Chart(ctx2, {
        type: 'line',
        data: {
          labels: monthLabels,
          datasets: [{ label: 'Revenue', data: monthLabels.map(m => monthlyData[m]), borderColor: '#667eea', tension: 0.4, borderWidth: 2, fill: false }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });
    }

    function generateGSTReport() {
      const start = new Date(document.getElementById('reportStart').value);
      const end = new Date(document.getElementById('reportEnd').value);
      if (!start || !end) { alert('Select dates'); return; }

      let cscAmount = 0, cscGST = 0, estampAmount = 0, estampGST = 0, docAmount = 0, docGST = 0;
      services.forEach(s => {
        const d = s.date.toDate ? s.date.toDate() : new Date(s.date);
        if (d >= start && d <= end) {
          if (s.serviceType === 'csc') { cscAmount += s.amount; cscGST += s.gstAmount; }
          else if (s.serviceType === 'estamping') { estampAmount += s.amount; estampGST += s.gstAmount; }
          else { docAmount += s.amount; docGST += s.gstAmount; }
        }
      });

      const totalAmount = cscAmount + estampAmount + docAmount;
      const totalGST = cscGST + estampGST + docGST;

      let html = `<div class="tax-summary">
        <h3>GST Report: ${start.toLocaleDateString()} to ${end.toLocaleDateString()}</h3>
        <p><span class="bold">GSTIN:</span> ${businessSettings.gstin}</p>
        <p><span class="bold">Business:</span> ${businessSettings.name}</p>
        <hr style="margin: 15px 0;">
        <h4>Service-wise Breakdown:</h4>
        <p>CSC Services: ‚Çπ${cscAmount.toFixed(2)} | GST: ‚Çπ${cscGST.toFixed(2)} | Total: ‚Çπ${(cscAmount + cscGST).toFixed(2)}</p>
        <p>E-Stamping: ‚Çπ${estampAmount.toFixed(2)} | GST: ‚Çπ${estampGST.toFixed(2)} | Total: ‚Çπ${(estampAmount + estampGST).toFixed(2)}</p>
        <p>Document Writing: ‚Çπ${docAmount.toFixed(2)} | GST: ‚Çπ${docGST.toFixed(2)} | Total: ‚Çπ${(docAmount + docGST).toFixed(2)}</p>
        <hr style="margin: 15px 0;">
        <p><span class="bold" style="font-size: 16px;">Total Revenue: ‚Çπ${totalAmount.toFixed(2)}</span></p>
        <p><span class="bold" style="font-size: 16px;">Total GST Collected: ‚Çπ${totalGST.toFixed(2)}</span></p>
        <p><span class="bold" style="font-size: 16px; color: #10b981;">Grand Total: ‚Çπ${(totalAmount + totalGST).toFixed(2)}</span></p>
      </div>`;
      document.getElementById('taxReportContent').innerHTML = html;
    }

    function generateITCReport() {
      alert('ITC Report: Track Input Tax Credit - Document all purchases with GST invoices');
    }

    function exportTaxCSV() {
      let csv = 'Service Type,SAC Code,Date,Amount,GST Rate,GST Amount,Total Amount\n';
      services.forEach(s => {
        const date = s.date.toDate ? s.date.toDate().toLocaleDateString() : new Date(s.date).toLocaleDateString();
        csv += `"${SERVICE_NAMES[s.serviceType]}","${s.sacCode}","${date}","${s.amount}","${s.gstRate}%","${s.gstAmount}","${s.totalAmount}"\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'Tax_Report_' + new Date().toLocaleDateString() + '.csv';
      a.click();
    }

    function switchTab(name) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(name).classList.add('active');
      event.target.classList.add('active');
      if (name === 'dashboard') updateCharts();
    }

    function logout() {
      auth.signOut();
    }
  </script>
</body>
</html>
